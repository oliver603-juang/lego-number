<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>樂高抽屜管家 (智慧預測版)</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const fallbackConfig = {
          apiKey: "AIzaSyAXwfm45p417iStJ556rYxR-qsty6dSaXc",
          authDomain: "lego-number.firebaseapp.com",
          projectId: "lego-number",
          storageBucket: "lego-number.firebasestorage.app",
          messagingSenderId: "1041577725604",
          appId: "1:1041577725604:web:b46696cd0933d1a3602031",
          measurementId: "G-25BT9NGHW1"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Init Error", e); }

        window.mappings = {}; 
        window.searchIndex = []; 

        async function initApp() {
            if (!auth) return;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-cloud text-green-500"></i>';
                    startSync(user);
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        function startSync(user) {
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            onSnapshot(collRef, (snapshot) => {
                const newMappings = {};
                const newIndex = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let drawers = [];
                    if (Array.isArray(data.drawers)) drawers = data.drawers;
                    else if (data.drawer_id) drawers = [data.drawer_id];
                    
                    const partData = {
                        drawers: drawers,
                        name: data.part_name || "",
                        img: data.img_url || "" 
                    };

                    if (drawers.length > 0) {
                        newMappings[doc.id] = partData;
                        // Build Search Index
                        newIndex.push({
                            id: doc.id,
                            name: partData.name,
                            img: partData.img,
                            // Pre-compute lowercase string for fast search
                            searchStr: `${doc.id} ${partData.name}`.toLowerCase()
                        });
                    }
                });
                window.mappings = newMappings;
                window.searchIndex = newIndex;

                if (currentPartId) checkAndDisplayDrawer(currentPartId);
            });
        }

        // --- Database Actions ---
        window.saveMappingCloud = async (partId, drawerId, partName, imgUrl, mode = 'append') => {
            if (!db) return;
            const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
            try {
                const docSnap = await getDoc(docRef);
                if (mode === 'move') { 
                    const oldData = docSnap.exists() ? docSnap.data() : {};
                    await (docSnap.exists() ? updateDoc : setDoc)(docRef, {
                        part_id: partId,
                        drawers: [drawerId], 
                        part_name: partName || oldData.part_name || "",
                        img_url: imgUrl ? imgUrl : (oldData.img_url || ""),
                        updated_at: new Date().toISOString()
                    });
                } else { 
                    if (docSnap.exists()) {
                        await updateDoc(docRef, {
                            drawers: arrayUnion(drawerId),
                            part_name: partName || docSnap.data().part_name,
                            img_url: imgUrl ? imgUrl : docSnap.data().img_url,
                            updated_at: new Date().toISOString()
                        });
                    } else {
                        await setDoc(docRef, {
                            part_id: partId,
                            drawers: [drawerId],
                            part_name: partName,
                            img_url: imgUrl || "",
                            updated_at: new Date().toISOString()
                        });
                    }
                }
            } catch (e) {
                alert("儲存失敗: " + e.message);
                throw e;
            }
        };

        window.removeMappingCloud = async (partId, drawerIdToRemove) => {
            if (!db) return;
            try {
                const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
                await updateDoc(docRef, { drawers: arrayRemove(drawerIdToRemove) });
            } catch (e) { alert("刪除失敗"); }
        };

        window.clearAllCloudData = async () => {
            if (!db || !confirm("【嚴重警告】確定要清空所有資料嗎？") || !confirm("再次確認：此操作無法復原！")) return;
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            const snapshot = await getDocs(collRef);
            const batchSize = 500;
            let batch = writeBatch(db);
            let count = 0;
            for (const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= batchSize) { await batch.commit(); batch = writeBatch(db); count = 0; }
            }
            if (count > 0) await batch.commit();
            alert("已清空資料庫");
            toggleSettings();
        };

        initApp();
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pb-keypad { padding-bottom: 350px; } 
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        /* 預測選單選中樣式 */
        .suggestion-item.active { background-color: #ebf8ff; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-cubes mr-2"></i>樂高管家</h1>
            <div class="flex items-center space-x-4">
                <div id="cloud-status" class="text-xs">...</div>
                <button onclick="toggleSettings()" class="hover:text-blue-200"><i class="fa-solid fa-gear text-xl"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow p-4 max-w-md mx-auto w-full pb-24 transition-all relative">
        
        <!-- 1. 統一搜尋區 -->
        <div class="bg-white p-6 rounded-xl shadow-lg text-center mb-6 relative z-30">
            <div class="mb-4 relative group cursor-pointer" onclick="document.getElementById('camera-input').click()">
                <div id="preview-container" class="w-full h-40 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden relative transition hover:border-blue-400 hover:bg-blue-50">
                    <div class="text-gray-400 flex flex-col items-center">
                        <i class="fa-solid fa-camera text-4xl mb-2"></i>
                        <span class="text-sm font-bold">點擊拍照辨識</span>
                    </div>
                    <img id="preview-img" class="absolute inset-0 w-full h-full object-contain hidden" />
                </div>
            </div>
            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleImage(this)">

            <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-2"></div>
                <span id="loading-text" class="text-xs text-gray-500">處理中...</span>
            </div>

            <!-- Manual Input with Enhanced Autocomplete -->
            <div class="relative">
                <div class="flex items-center border-b-2 border-gray-200 focus-within:border-blue-500 py-2 px-2 mt-2">
                    <i class="fa-solid fa-keyboard text-gray-400 mr-3"></i>
                    <input type="text" id="part-id-input" class="flex-1 bg-transparent outline-none font-mono font-bold text-lg text-gray-700 placeholder-gray-300" placeholder="輸入 ID 或關鍵字..." oninput="handleInputSearch(this.value)" onkeydown="handleSearchKeydown(event)" autocomplete="off">
                    <button id="retry-btn" onclick="retryWithGemini()" class="hidden text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full ml-2 font-bold flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Gemini
                    </button>
                </div>
                <!-- Search Suggestions Dropdown -->
                <div id="search-suggestions" class="absolute top-full left-0 right-0 bg-white shadow-xl rounded-b-xl border border-t-0 border-gray-200 max-h-72 overflow-y-auto hidden z-40">
                    <!-- Items will be injected here -->
                </div>
            </div>
        </div>

        <!-- 2. 結果與操作區 (動態內容) -->
        <div id="result-area" class="hidden space-y-4">
            
            <!-- 資訊卡 -->
            <div class="bg-white p-4 rounded-xl shadow-lg border-l-4" id="info-card">
                <!-- 頭部資訊 -->
                <div class="flex items-start mb-4">
                    <img id="api-img" src="" class="w-20 h-20 object-contain bg-gray-50 rounded border border-gray-200 mr-4 hidden">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h2 class="text-3xl font-black font-mono text-gray-800 leading-none" id="res-part-id">---</h2>
                            <span id="res-source" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">SRC</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1 leading-tight break-words" id="res-part-name">---</p>
                    </div>
                </div>

                <!-- 狀態 A: 已存在 (顯示位置 + 操作按鈕) -->
                <div id="status-exist" class="hidden">
                    <div class="mb-4">
                        <p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">Current Location</p>
                        <div id="drawer-list" class="flex flex-wrap gap-2">
                            <!-- Tags go here -->
                        </div>
                    </div>
                    
                    <!-- 按鈕群 -->
                    <div class="grid grid-cols-2 gap-3" id="exist-actions">
                        <button onclick="showActionPanel('add')" class="bg-blue-50 border border-blue-200 text-blue-700 py-3 rounded-lg font-bold text-sm hover:bg-blue-100 flex justify-center items-center">
                            <i class="fa-solid fa-plus-circle mr-2 text-lg"></i> 新增位置
                        </button>
                        <button onclick="showActionPanel('move')" class="bg-red-50 border border-red-200 text-red-700 py-3 rounded-lg font-bold text-sm hover:bg-red-100 flex justify-center items-center">
                            <i class="fa-solid fa-arrow-right-arrow-left mr-2 text-lg"></i> 移動位置
                        </button>
                    </div>
                </div>

                <!-- 狀態 B: 未登錄 (直接顯示入庫面板 + 相似推薦) -->
                <div id="status-new" class="hidden">
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-3">
                        <p class="text-yellow-800 font-bold text-sm flex items-center">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i> 尚未登錄，設定新位置：
                        </p>
                    </div>
                    <!-- 入庫面板容器 -->
                    <div id="inline-action-panel"></div> 

                    <!-- 相似零件推薦 (融合建議) -->
                    <div id="similar-suggestions" class="mt-4 pt-4 border-t border-gray-100 hidden">
                        <p class="text-xs font-bold text-gray-500 mb-2 flex items-center">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1 text-purple-500"></i> 發現相似零件 (點擊可融合)：
                        </p>
                        <div id="similar-list" class="space-y-2">
                            <!-- Similar items injected here -->
                        </div>
                    </div>
                </div>

                <!-- 動態操作面板容器 (for Exist mode) -->
                <div id="dynamic-action-area" class="mt-4 hidden border-t border-gray-100 pt-4"></div>
            </div>

            <!-- 操作面板模板 (隱藏) -->
            <div id="action-panel-template" class="hidden">
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-gray-700" id="action-label">目標抽屜：</span>
                        <div class="flex items-center gap-2">
                             <button onclick="adjustDrawer(-1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-minus"></i></button>
                             
                             <input type="text" id="drawer-input" class="w-24 p-2 border-2 border-blue-500 rounded-lg text-center text-2xl font-black text-blue-700 bg-white cursor-pointer shadow-inner" readonly onclick="openKeypad('drawer-input')">
                             
                             <button onclick="adjustDrawer(1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-end gap-2 mb-1">
                        <label class="flex items-center space-x-2 cursor-pointer select-none">
                            <input type="checkbox" id="drawer-sub" class="w-5 h-5 accent-blue-600 rounded">
                            <span class="text-sm font-bold text-gray-500">夾層 a</span>
                        </label>
                    </div>

                    <button id="confirm-btn" class="w-full py-3.5 rounded-xl font-bold text-white shadow-md transition-all active:scale-95 text-lg flex justify-center items-center">
                        確認
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Keypad Modal -->
    <div id="keypad-modal" class="fixed inset-0 z-[70] hidden flex items-end justify-center pointer-events-none">
        <div class="bg-white w-full max-w-md shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl p-5 pointer-events-auto transform transition-transform duration-300 translate-y-full" id="keypad-content">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-400 font-bold text-sm tracking-wider uppercase">Keypad</span>
                <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="k('1')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">1</button>
                <button onclick="k('2')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">2</button>
                <button onclick="k('3')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">3</button>
                
                <button onclick="k('4')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">4</button>
                <button onclick="k('5')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">5</button>
                <button onclick="k('6')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">6</button>
                
                <button onclick="k('7')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">7</button>
                <button onclick="k('8')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">8</button>
                <button onclick="k('9')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">9</button>
                
                <button onclick="k('del')" class="bg-red-50 border-b-4 border-red-200 rounded-xl p-3 text-red-500 text-xl font-bold active:border-b-0 active:translate-y-1 transition-all"><i class="fa-solid fa-delete-left"></i></button>
                <button onclick="k('0')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">0</button>
                <button onclick="k('ok')" class="bg-blue-600 border-b-4 border-blue-800 rounded-xl p-3 text-white text-xl font-bold active:border-b-0 active:translate-y-1 transition-all">OK</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800">設定</h3>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">Gemini API Key</label>
                <input type="password" id="gemini-key" class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 outline-none">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">AI Model</label>
                <select id="gemini-model" class="w-full border-2 border-gray-200 rounded-lg p-2 bg-white">
                    <option value="gemini-1.5-flash">1.5 Flash (推薦)</option>
                    <option value="gemini-1.5-pro">1.5 Pro</option>
                    <option value="gemini-2.0-flash-exp">2.0 Flash Exp</option>
                </select>
            </div>
            <hr class="border-gray-100 mb-4">
            <button onclick="window.clearAllCloudData()" class="w-full text-red-500 border border-red-200 bg-red-50 p-3 rounded-lg mb-4 text-sm font-bold hover:bg-red-100 transition">
                <i class="fa-solid fa-trash-can mr-2"></i> 清空所有資料
            </button>
            <div class="flex justify-end gap-3">
                <button onclick="toggleSettings()" class="px-5 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">取消</button>
                <button onclick="saveSettings()" class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700">儲存</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentPartId = null;
        let currentPartName = "";
        let currentPartImgUrl = "";
        let currentResizedBlob = null;
        let currentKeypadTarget = null;
        let currentAction = 'append'; 
        
        let geminiApiKey = localStorage.getItem('lego_gemini_key') || "";
        let geminiModel = localStorage.getItem('lego_gemini_model') || "gemini-1.5-flash";

        // Autocomplete Selection
        let selectedSuggestionIndex = -1;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }

        // --- Search & Autocomplete Logic (Updated) ---
        window.handleInputSearch = (value) => {
            selectedSuggestionIndex = -1; // Reset selection
            const suggestionsBox = document.getElementById('search-suggestions');
            if (!value || value.length < 1) { // 允許單字搜尋
                suggestionsBox.classList.add('hidden');
                return;
            }

            const terms = value.toLowerCase().split(/\s+/).filter(t => t.length > 0);
            
            // 智慧評分機制
            const candidates = window.searchIndex.map(item => {
                let score = 0;
                const idLower = item.id.toLowerCase();
                
                // 1. ID 匹配 (權重最高)
                if (idLower === value.toLowerCase()) score += 100;
                else if (idLower.startsWith(value.toLowerCase())) score += 80;
                else if (idLower.includes(value.toLowerCase())) score += 20;

                // 2. 名稱匹配 (支援多關鍵字，例如 "plate red")
                let allTermsMatch = true;
                terms.forEach(term => {
                    if (!item.searchStr.includes(term)) allTermsMatch = false;
                });

                if (allTermsMatch) {
                    score += 10;
                    // 如果名稱開頭符合，加分
                    if (item.name.toLowerCase().startsWith(terms[0])) score += 30;
                } else {
                    if (score === 0) return null; // 完全不符合
                }

                return { ...item, score };
            }).filter(item => item !== null && item.score > 0);

            // 排序：分數高 -> 低
            candidates.sort((a, b) => b.score - a.score);
            const topMatches = candidates.slice(0, 8); // 顯示前8個

            if (topMatches.length > 0) {
                suggestionsBox.innerHTML = topMatches.map((m, index) => {
                    // Highlight Logic
                    const highlightedName = highlightText(m.name, value);
                    const highlightedId = highlightText(m.id, value);

                    return `
                        <div id="suggestion-${index}" class="suggestion-item flex items-center p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 transition-colors" onclick="selectSuggestion('${m.id}')">
                            ${m.img ? `<img src="${m.img}" class="w-10 h-10 object-contain mr-3 bg-gray-50 rounded border">` : '<div class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center"><i class="fa-solid fa-cube text-gray-300"></i></div>'}
                            <div class="overflow-hidden flex-1">
                                <div class="font-bold font-mono text-blue-600 flex justify-between items-center">
                                    <span>${highlightedId}</span>
                                    <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">ID</span>
                                </div>
                                <div class="text-xs text-gray-500 truncate mt-0.5">${highlightedName}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                suggestionsBox.classList.remove('hidden');
            } else {
                suggestionsBox.classList.add('hidden');
            }
        };

        function highlightText(text, query) {
            if(!query) return text;
            // 簡單的高亮：將輸入的字串用黃底標示 (case insensitive)
            const terms = query.split(/\s+/).filter(t => t.length > 0);
            let result = text;
            terms.forEach(term => {
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                result = result.replace(regex, '<span class="bg-yellow-200 text-gray-900 font-bold">$1</span>');
            });
            return result;
        }

        window.selectSuggestion = (id) => {
            document.getElementById('part-id-input').value = id;
            document.getElementById('search-suggestions').classList.add('hidden');
            manualSearch();
        };

        window.handleSearchKeydown = (e) => {
            const box = document.getElementById('search-suggestions');
            if (box.classList.contains('hidden')) return;
            
            const items = box.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex++;
                if (selectedSuggestionIndex >= items.length) selectedSuggestionIndex = 0;
                updateSelectionStyle(items);
                // Auto scroll
                items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'});
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex--;
                if (selectedSuggestionIndex < 0) selectedSuggestionIndex = items.length - 1;
                updateSelectionStyle(items);
                items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'});
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSuggestionIndex > -1) {
                    items[selectedSuggestionIndex].click();
                } else {
                    // Manual enter -> search directly
                    manualSearch();
                    box.classList.add('hidden');
                }
            } else if (e.key === 'Escape') {
                box.classList.add('hidden');
            }
        };

        function updateSelectionStyle(items) {
            items.forEach((item, idx) => {
                if (idx === selectedSuggestionIndex) {
                    item.classList.add('active'); // CSS class for highlight
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ... [Rest of the file remains unchanged: checkAndDisplayDrawer, handleImage, saveMapping, etc.] ...
        
        function getNextEmptyDrawerId() {
            const used = new Set();
            Object.values(window.mappings || {}).forEach(d => {
                if(d.drawers) d.drawers.forEach(dr => used.add(dr.toString().replace('a','')));
            });
            for(let i=1; i<=9999; i++) if(!used.has(i.toString())) return i;
            return 1;
        }

        // --- Similarity Logic ---
        function levenshtein(a, b) {
            if(a.length === 0) return b.length; 
            if(b.length === 0) return a.length; 
            var matrix = []; 
            for(var i = 0; i <= b.length; i++){ matrix[i] = [i]; } 
            for(var j = 0; j <= a.length; j++){ matrix[0][j] = j; } 
            for(var i = 1; i <= b.length; i++){ 
                for(var j = 1; j <= a.length; j++){ 
                    if(b.charAt(i-1) == a.charAt(j-1)){ 
                        matrix[i][j] = matrix[i-1][j-1]; 
                    } else { 
                        matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1)); 
                    } 
                } 
            } 
            return matrix[b.length][a.length]; 
        }

        function findSimilarParts(targetName) {
            if (!targetName) return [];
            const candidates = [];
            const target = targetName.toLowerCase();
            
            Object.entries(window.mappings).forEach(([id, data]) => {
                if (data.name && data.drawers.length > 0) {
                    const dist = levenshtein(target, data.name.toLowerCase());
                    candidates.push({ ...data, id, dist });
                }
            });

            // Sort ascending distance
            candidates.sort((a, b) => a.dist - b.dist);
            return candidates.slice(0, 3);
        }

        function checkAndDisplayDrawer(partId) {
            currentPartId = partId;
            const partData = (window.mappings || {})[partId];
            const drawers = partData ? partData.drawers : [];
            
            // Render Info
            document.getElementById('res-part-id').textContent = partId;
            document.getElementById('res-part-name').textContent = currentPartName || partData?.name || "---";
            
            // Image
            const img = document.getElementById('api-img');
            const url = currentPartImgUrl || partData?.img;
            if(url) { img.src = url; img.classList.remove('hidden'); }
            else { img.classList.add('hidden'); }

            document.getElementById('result-area').classList.remove('hidden');
            
            // UI State Switch
            const infoCard = document.getElementById('info-card');
            const statusExist = document.getElementById('status-exist');
            const statusNew = document.getElementById('status-new');
            const dynamicArea = document.getElementById('dynamic-action-area');
            const existActions = document.getElementById('exist-actions');

            if(drawers.length > 0) {
                // 情境 A: 已存在
                statusExist.classList.remove('hidden');
                statusNew.classList.add('hidden');
                dynamicArea.innerHTML = ''; 
                dynamicArea.classList.add('hidden');
                existActions.classList.remove('hidden'); 
                infoCard.className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-green-500 transition-all"; 
                
                const list = document.getElementById('drawer-list');
                list.innerHTML = drawers.map(d => 
                    `<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-1.5 rounded-lg font-bold shadow-sm flex items-center">
                        <i class="fa-solid fa-box-open mr-2 text-xs opacity-50"></i>${d}
                        <button onclick="removeLoc('${d}')" class="ml-3 w-5 h-5 flex items-center justify-center bg-white rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 shadow-sm transition"><i class="fa-solid fa-xmark text-xs"></i></button>
                     </div>`
                ).join('');
            } else {
                // 情境 B: 新零件
                statusExist.classList.add('hidden');
                statusNew.classList.remove('hidden');
                infoCard.className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-yellow-400 transition-all"; 

                // 嵌入入庫面板
                setupActionPanel('add', document.getElementById('inline-action-panel'));
                // Use default empty drawer
                const defDrawer = getNextEmptyDrawerId();
                const inp = document.getElementById('drawer-input-active');
                if(inp) inp.value = defDrawer;

                // 相似推薦
                const similarContainer = document.getElementById('similar-suggestions');
                const similarList = document.getElementById('similar-list');
                const suggestions = findSimilarParts(currentPartName || "");

                if (suggestions.length > 0) {
                    similarList.innerHTML = suggestions.map(s => `
                        <div class="flex items-center p-2 bg-white border border-purple-100 rounded-lg cursor-pointer hover:bg-purple-50 transition shadow-sm group" onclick="useSuggestedDrawer('${s.drawers[0]}')">
                            ${s.img ? `<img src="${s.img}" class="w-10 h-10 object-contain rounded border mr-3 bg-gray-50">` : '<div class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center"><i class="fa-solid fa-cube text-gray-400"></i></div>'}
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-bold text-gray-700 truncate">${s.name}</div>
                                <div class="text-[10px] text-gray-500 font-mono">ID: ${s.id}</div>
                            </div>
                            <span class="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded group-hover:bg-purple-200 transition">抽屜 ${s.drawers[0]}</span>
                        </div>
                    `).join('');
                    similarContainer.classList.remove('hidden');
                } else {
                    similarContainer.classList.add('hidden');
                }
            }
        }

        // --- Apply Suggestion ---
        window.useSuggestedDrawer = (drawerId) => {
            const dStr = drawerId.toString();
            const isSub = dStr.includes('a');
            const num = dStr.replace('a', '');
            
            const input = document.getElementById('drawer-input-active'); 
            const activeContainer = input.closest('#inline-action-panel') || document.getElementById('dynamic-action-area');
            const checkbox = activeContainer.querySelector('input[type="checkbox"]');
            
            if(input) input.value = num;
            if(checkbox) checkbox.checked = isSub;
            
            input.scrollIntoView({behavior: 'smooth', block: 'center'});
        };

        // --- Action Panel Logic ---
        window.showActionPanel = (action) => {
            const container = document.getElementById('dynamic-action-area');
            container.classList.remove('hidden');
            document.getElementById('exist-actions').classList.add('hidden'); 
            setupActionPanel(action, container);
            document.getElementById('drawer-input-active').value = getNextEmptyDrawerId(); 
        };

        function setupActionPanel(action, container) {
            currentAction = action;
            const template = document.getElementById('action-panel-template');
            container.innerHTML = template.innerHTML; 
            
            const btn = container.querySelector('#confirm-btn');
            const label = container.querySelector('#action-label');
            
            if (action === 'add') {
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> 確認加入';
                label.textContent = "加入位置：";
            } else {
                btn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                btn.innerHTML = '<i class="fa-solid fa-arrow-right-arrow-left mr-2"></i> 確認移動 (覆蓋)';
                label.textContent = "移動至：";
            }

            const input = container.querySelector('#drawer-input');
            input.id = 'drawer-input-active'; 
            input.onclick = () => openKeypad('drawer-input-active');
            
            container.querySelector('#confirm-btn').onclick = executeAction;
        }

        window.adjustDrawer = (delta) => {
            const input = document.getElementById('drawer-input-active'); 
            if(!input) return;
            let val = parseInt(input.value) || 1;
            val += delta;
            if(val < 1) val = 1;
            if(val > 9999) val = 9999;
            input.value = val;
        };

        window.executeAction = async () => {
            if(!currentPartId) return;
            const num = document.getElementById('drawer-input-active').value;
            const activeContainer = document.getElementById('drawer-input-active').closest('#inline-action-panel') || document.getElementById('dynamic-action-area');
            const isSubChecked = activeContainer.querySelector('input[type="checkbox"]').checked;

            const targetDrawer = isSubChecked ? `${num}a` : `${num}`;
            
            const btn = activeContainer.querySelector('#confirm-btn'); 
            const originalHtml = btn.innerHTML;
            const originalClass = btn.className;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                if (currentAction === 'move') {
                    if(confirm(`確定將 ${currentPartId} 移動到 ${targetDrawer} 嗎？\n舊位置將被移除。`)) {
                        await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'move');
                    } else {
                        btn.innerHTML = originalHtml; btn.disabled = false; return;
                    }
                } else {
                    await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'append');
                }
                
                btn.className = "w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-green-500 transition-all";
                btn.innerHTML = '<i class="fa-solid fa-check"></i> 成功';
                
                setTimeout(() => {
                    btn.className = originalClass;
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    if(document.getElementById('status-exist').classList.contains('hidden') === false) {
                         document.getElementById('exist-actions').classList.remove('hidden');
                         document.getElementById('dynamic-action-area').classList.add('hidden');
                    }
                }, 1500);

            } catch(e) {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        };

        window.removeLoc = (drawerId) => {
            if(confirm(`確定從 ${drawerId} 移除此零件？`)) {
                window.removeMappingCloud(currentPartId, drawerId);
            }
        };

        // --- Image & AI ---
        window.handleImage = async (input) => {
            if (!input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden'); 
            
            try {
                const blob = await resizeImage(file);
                currentResizedBlob = blob; 
                
                let result = await tryBrickognize(blob);
                
                if (!result) {
                    if (geminiApiKey) {
                        document.getElementById('loading-text').innerText = "Brickognize 無結果，切換至 Gemini AI...";
                        result = await tryGemini(blob);
                    } else { throw new Error("Brickognize 無結果且未設定 API Key"); }
                }
                
                currentPartName = result.name;
                currentPartImgUrl = result.img;
                document.getElementById('part-id-input').value = result.id;
                document.getElementById('res-source').textContent = result.source;
                document.getElementById('res-source').className = `text-[10px] px-2 py-0.5 rounded font-bold text-white ${result.source==='Brickognize'?'bg-green-500':'bg-purple-500'}`;

                checkAndDisplayDrawer(result.id);
                document.getElementById('retry-btn').classList.remove('hidden');

            } catch (e) {
                alert(e.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading-text').innerText = "處理中...";
                input.value = '';
            }
        };
        
        window.manualSearch = () => {
            const id = document.getElementById('part-id-input').value.trim();
            if(id) {
                currentPartName = ""; 
                currentPartImgUrl = "";
                document.getElementById('res-source').textContent = "MANUAL";
                document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-gray-500 text-white font-bold";
                document.getElementById('search-suggestions').classList.add('hidden');
                checkAndDisplayDrawer(id);
            }
        };

        window.retryWithGemini = async () => {
             if(!currentResizedBlob || !geminiApiKey) { alert("無圖片或未設定 Key"); return; }
             document.getElementById('loading').classList.remove('hidden');
             document.getElementById('loading-text').innerText = "Gemini 重試中...";
             document.getElementById('result-area').classList.add('hidden');
             try {
                 const result = await tryGemini(currentResizedBlob);
                 currentPartName = result.name;
                 currentPartImgUrl = ""; 
                 document.getElementById('part-id-input').value = result.id;
                 document.getElementById('res-source').textContent = "Gemini (Retry)";
                 document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-purple-600 text-white font-bold";
                 checkAndDisplayDrawer(result.id);
             } catch(e) { alert(e.message); }
             finally { document.getElementById('loading').classList.add('hidden'); }
        };

        // --- Helpers ---
        function resizeImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        if (width > 800) { height = Math.round(height * 800 / width); width = 800; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        canvas.toBlob(resolve, 'image/jpeg', 0.85);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function tryBrickognize(blob) {
            const fd = new FormData(); fd.append('query_image', blob);
            const res = await fetch('https://api.brickognize.com/predict/', {method:'POST', body:fd});
            if(res.ok) {
                const data = await res.json();
                if(data.items?.length > 0) return { 
                    id: data.items[0].id, 
                    name: data.items[0].name, 
                    img: data.items[0].img_url || data.items[0].thumbnail_url,
                    source: 'Brickognize'
                };
            }
            return null;
        }

        async function tryGemini(blob) {
            const b64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); });
            const prompt = `Identify this Lego part. Return JSON: { "id": "PART_ID", "name": "Part Name" }. 
            IMPORTANT: ALWAYS Append common Traditional Chinese keywords for this part (e.g., "Brick 2x4 基礎磚", "Technic Beam 科技臂", "Gear 齒輪").`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ contents:[{parts:[{text:prompt}, {inline_data:{mime_type:"image/jpeg", data:b64}}]}], generationConfig:{responseMimeType:"application/json"} })
            });
            if(!res.ok) throw new Error("API Error");
            const json = await res.json();
            const data = JSON.parse(json.candidates[0].content.parts[0].text);
            return { id: data.id, name: data.name, img: "", source: 'Gemini' };
        }

        // --- Keypad ---
        window.k = (key) => {
            const inp = document.getElementById('drawer-input-active');
            if(!inp) return;
            if(key==='del') inp.value = inp.value.slice(0,-1);
            else if(key==='clr') inp.value = '';
            else if(key==='ok') closeKeypad();
            else inp.value += key;
        };
        window.openKeypad = (id) => {
            const modal = document.getElementById('keypad-modal');
            const content = document.getElementById('keypad-content');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => content.classList.remove('translate-y-full'));
            document.getElementById('main-content').classList.add('pb-keypad');
            setTimeout(() => document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}), 300);
        };
        window.closeKeypad = () => {
            const modal = document.getElementById('keypad-modal');
            document.getElementById('keypad-content').classList.add('translate-y-full');
            setTimeout(() => { modal.classList.add('hidden'); document.getElementById('main-content').classList.remove('pb-keypad'); }, 300);
        };

        // Settings
        window.toggleSettings = () => {
            const m = document.getElementById('settings-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('gemini-key').value = geminiApiKey;
                document.getElementById('gemini-model').value = geminiModel;
                if(geminiApiKey) document.getElementById('key-saved-msg').classList.remove('hidden');
                else document.getElementById('key-saved-msg').classList.add('hidden');
            }
        };
        window.saveSettings = () => {
            geminiApiKey = document.getElementById('gemini-key').value.trim();
            geminiModel = document.getElementById('gemini-model').value;
            localStorage.setItem('lego_gemini_key', geminiApiKey);
            localStorage.setItem('lego_gemini_model', geminiModel);
            toggleSettings();
            showMessage("設定已儲存", "success");
        };

        if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
    </script>
    
    <!-- Keypad UI -->
    <div id="keypad-modal" class="fixed inset-0 z-[70] hidden flex items-end justify-center pointer-events-none">
        <div class="bg-white w-full max-w-md shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl p-5 pointer-events-auto transform transition-transform duration-300 translate-y-full" id="keypad-content">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-400 font-bold text-sm tracking-wider uppercase">Keypad</span>
                <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="k('1')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">1</button>
                <button onclick="k('2')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">2</button>
                <button onclick="k('3')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">3</button>
                
                <button onclick="k('4')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">4</button>
                <button onclick="k('5')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">5</button>
                <button onclick="k('6')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">6</button>
                
                <button onclick="k('7')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">7</button>
                <button onclick="k('8')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">8</button>
                <button onclick="k('9')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">9</button>
                
                <button onclick="k('del')" class="bg-red-50 border-b-4 border-red-200 rounded-xl p-3 text-red-500 text-xl font-bold active:border-b-0 active:translate-y-1 transition-all"><i class="fa-solid fa-delete-left"></i></button>
                <button onclick="k('0')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">0</button>
                <button onclick="k('ok')" class="bg-blue-600 border-b-4 border-blue-800 rounded-xl p-3 text-white text-xl font-bold active:border-b-0 active:translate-y-1 transition-all">OK</button>
            </div>
        </div>
    </div>

</body>
</html>
