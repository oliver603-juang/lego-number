<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>樂高抽屜管家 (雙鏡頭旗艦版)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyAXwfm45p417iStJ556rYxR-qsty6dSaXc",
          authDomain: "lego-number.firebaseapp.com",
          projectId: "lego-number",
          storageBucket: "lego-number.firebasestorage.app",
          messagingSenderId: "1041577725604",
          appId: "1:1041577725604:web:b46696cd0933d1a3602031",
          measurementId: "G-25BT9NGHW1"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Init Error", e); }

        window.mappings = {}; 
        window.inventoryIndex = []; 

        // --- 樂高零件字典 (Brick Architect Categories) ---
        window.catalogIndex = [
            // 1. BASIC
            {id: "3005", name: "Brick 1 x 1"}, {id: "3004", name: "Brick 1 x 2"}, {id: "3622", name: "Brick 1 x 3"},
            {id: "3010", name: "Brick 1 x 4"}, {id: "3009", name: "Brick 1 x 6"}, {id: "3008", name: "Brick 1 x 8"},
            {id: "6111", name: "Brick 1 x 10"}, {id: "6112", name: "Brick 1 x 12"}, {id: "2465", name: "Brick 1 x 16"},
            {id: "3003", name: "Brick 2 x 2"}, {id: "3002", name: "Brick 2 x 3"}, {id: "3001", name: "Brick 2 x 4"},
            {id: "2456", name: "Brick 2 x 6"}, {id: "3007", name: "Brick 2 x 8"}, {id: "3006", name: "Brick 2 x 10"},
            {id: "2357", name: "Brick 2 x 2 Corner"}, {id: "76766", name: "Brick 2 x 2 Corner 45 Degrees"},
            {id: "3024", name: "Plate 1 x 1"}, {id: "3023", name: "Plate 1 x 2"}, {id: "3623", name: "Plate 1 x 3"},
            {id: "3710", name: "Plate 1 x 4"}, {id: "3666", name: "Plate 1 x 6"}, {id: "3460", name: "Plate 1 x 8"},
            {id: "4477", name: "Plate 1 x 10"}, {id: "60479", name: "Plate 1 x 12"},
            {id: "3022", name: "Plate 2 x 2"}, {id: "3021", name: "Plate 2 x 3"}, {id: "3020", name: "Plate 2 x 4"},
            {id: "3795", name: "Plate 2 x 6"}, {id: "3034", name: "Plate 2 x 8"}, {id: "3832", name: "Plate 2 x 10"},
            {id: "3029", name: "Plate 4 x 12"}, {id: "3032", name: "Plate 4 x 6"}, {id: "3031", name: "Plate 4 x 4"},
            {id: "2420", name: "Plate 2 x 2 Corner"},
            {id: "3070b", name: "Tile 1 x 1"}, {id: "3069b", name: "Tile 1 x 2"}, {id: "63864", name: "Tile 1 x 3"},
            {id: "2431", name: "Tile 1 x 4"}, {id: "6636", name: "Tile 1 x 6"}, {id: "4162", name: "Tile 1 x 8"},
            {id: "3068b", name: "Tile 2 x 2"}, {id: "14719", name: "Tile 2 x 2 Corner"}, {id: "87079", name: "Tile 2 x 4"},
            {id: "2412b", name: "Tile, Modified 1 x 2 Grille"}, 

            // 2. WALL
            {id: "98283", name: "Brick, Modified 1 x 2 Masonry"}, {id: "2877", name: "Brick, Modified 1 x 2 with Grille"},
            {id: "14716", name: "Brick 1 x 1 x 3"}, {id: "2453", name: "Brick 1 x 1 x 5"}, {id: "2454", name: "Brick 1 x 2 x 5"},
            {id: "60592", name: "Window 1 x 2 x 2 Flat Front"}, {id: "60593", name: "Window 1 x 2 x 3 Flat Front"},
            {id: "60594", name: "Window 1 x 4 x 3"}, {id: "62113", name: "Window 1 x 4 x 3 Paned"},
            {id: "60596", name: "Door Frame 1 x 4 x 6"}, {id: "60616", name: "Door 1 x 4 x 6"},
            {id: "4865b", name: "Panel 1 x 2 x 1"}, {id: "23950", name: "Panel 1 x 3 x 1"}, {id: "87552", name: "Panel 1 x 2 x 2"},
            {id: "15207", name: "Panel 3 x 4 x 6"},

            // 3. SNOT
            {id: "87087", name: "Brick 1 x 1 with Stud on Side"}, {id: "4070", name: "Brick 1 x 1 Headlight"},
            {id: "26604", name: "Brick 1 x 1 with 2 Studs Adjacent"}, {id: "4733", name: "Brick 1 x 1 with 4 Studs"},
            {id: "22885", name: "Brick 1 x 2 x 1 2/3 with Studs on Side"},
            {id: "99781", name: "Bracket 1 x 2 - 1 x 2"}, {id: "99780", name: "Bracket 1 x 2 - 1 x 2 Inverted"},
            {id: "36840", name: "Bracket 1 x 1 - 1 x 1"}, {id: "36841", name: "Bracket 1 x 1 - 1 x 1 Inverted"},
            {id: "2436", name: "Bracket 1 x 2 - 1 x 4"}, {id: "99207", name: "Bracket 1 x 2 - 2 x 2"},
            {id: "15573", name: "Plate 1 x 2 with 1 Stud (Jumper)"}, {id: "87580", name: "Plate 2 x 2 with 1 Stud (Jumper)"},

            // 4. ANGLE
            {id: "54200", name: "Slope 30 1 x 1 x 2/3 (Cheese)"}, {id: "85984", name: "Slope 30 1 x 2 x 2/3"},
            {id: "3040b", name: "Slope 45 2 x 1"}, {id: "3039", name: "Slope 45 2 x 2"}, {id: "3037", name: "Slope 45 2 x 4"},
            {id: "3298", name: "Slope 33 3 x 2"}, {id: "3665", name: "Slope, Inverted 45 2 x 1"},
            {id: "24299", name: "Wedge, Plate 2 x 2 Left"}, {id: "24307", name: "Wedge, Plate 2 x 2 Right"},
            {id: "54383", name: "Wedge, Plate 3 x 6 Cut Corners"}, {id: "54384", name: "Wedge, Plate 6 x 3 Left"},

            // 5. CURVE
            {id: "11477", name: "Slope, Curved 2 x 1"}, {id: "15068", name: "Slope, Curved 2 x 2"},
            {id: "61678", name: "Slope, Curved 4 x 1"}, {id: "93273", name: "Slope, Curved 4 x 1 Double"},
            {id: "6091", name: "Brick, Modified 1 x 2 with Curved Top"},
            {id: "4073", name: "Plate, Round 1 x 1"}, {id: "6141", name: "Plate, Round 1 x 1"},
            {id: "3062b", name: "Brick, Round 1 x 1"}, {id: "3941", name: "Brick, Round 2 x 2"},
            {id: "98138", name: "Tile, Round 1 x 1"}, {id: "4150", name: "Tile, Round 2 x 2"},
            {id: "18674", name: "Tile, Round 2 x 2 with One Stud"},

            // 6. ARTICULATION
            {id: "4081b", name: "Plate 1 x 1 with Clip Light"}, {id: "4085d", name: "Plate 1 x 1 with Clip Vertical"},
            {id: "61252", name: "Plate 1 x 1 with Clip Horizontal"}, {id: "63868", name: "Plate 1 x 2 with Clip"},
            {id: "60478", name: "Plate 1 x 2 with Handle"}, {id: "48336", name: "Plate 1 x 2 with Handle on Side"},
            {id: "3937", name: "Hinge Brick 1 x 2 Base"}, {id: "3938", name: "Hinge Brick 1 x 2 Top"},
            {id: "14704", name: "Plate, Modified 1 x 2 with Small Towball Socket"},
            {id: "3614", name: "Plate, Round 1 x 1 with Towball"},

            // 7. MINIFIG
            {id: "3626c", name: "Minifig Head"}, {id: "973", name: "Minifig Torso"}, {id: "970c00", name: "Minifig Hips and Legs"},
            {id: "3901", name: "Minifig Hair Male"}, {id: "4530", name: "Minifig Hair Female"},
            {id: "4345", name: "Container Box 2 x 2 x 2"}, {id: "4346", name: "Container Box Door"},
            {id: "3899", name: "Minifig Cup/Mug"}, {id: "30176", name: "Plant, Bamboo Leaves"},

            // 8. VEHICLE
            {id: "4624", name: "Wheel 8mm D. x 6mm"}, {id: "50950", name: "Slope, Curved 3 x 1"},
            {id: "42610", name: "Wheel 11mm D. x 8mm"}, {id: "6014", name: "Wheel 11mm D. x 12mm"},
            {id: "18947", name: "Technic Driving Ring 3L"}, {id: "2412b", name: "Tile, Modified 1 x 2 Grille"},
            {id: "50943", name: "Vehicle Air Scoop 2 x 2"},

            // 9. TECHNIC
            {id: "2780", name: "Technic Pin Friction (Black)"}, {id: "3673", name: "Technic Pin No Friction (Grey)"},
            {id: "43093", name: "Technic Axle Pin Friction"}, {id: "3749", name: "Technic Axle Pin No Friction"},
            {id: "3705", name: "Technic Axle 4"}, {id: "3706", name: "Technic Axle 6"}, {id: "4519", name: "Technic Axle 3"},
            {id: "3700", name: "Technic Brick 1 x 2"}, {id: "32000", name: "Technic Brick 1 x 2 with Holes"},
            {id: "3894", name: "Technic Brick 1 x 6"},
            {id: "32523", name: "Technic Liftarm 1 x 3 Thick"}, {id: "32524", name: "Technic Liftarm 1 x 7 Thick"},
            {id: "32316", name: "Technic Liftarm 1 x 5 Thick"}, {id: "32063", name: "Technic Liftarm 1 x 6 Thin"},
            {id: "32140", name: "Technic Liftarm L-Shape 2 x 4"},
            {id: "32270", name: "Technic Gear 12 Tooth Double Bevel"}, {id: "3647", name: "Technic Gear 8 Tooth"},
            
            // 10. NATURE
            {id: "3741", name: "Plant Flower Stem"}, {id: "24866", name: "Flower 1x1"},
            {id: "32607", name: "Plant Plate, Round 1 x 1 with 3 Leaves"},
            {id: "2417", name: "Plant Leaves 6 x 5"},
            {id: "53451", name: "Barb / Claw / Horn - Small"},

        ].map(i => ({...i, searchStr: `${i.id} ${i.name}`.toLowerCase()}));

        // --- Top 360 Ranks ---
        window.partRanks = {
            "3023": 1, "3024": 2, "3004": 3, "3020": 4, "3005": 5, "3069b": 6, "54200": 7, "3710": 8, "3003": 9, "3022": 10,
            "3021": 11, "2780": 12, "3001": 13, "3002": 14, "3010": 15, "3623": 16, "3666": 17, "3009": 18, "3795": 19, "4073": 20,
            "11477": 21, "2420": 22, "85984": 23, "3068b": 24, "32028": 25, "98138": 26, "3008": 27, "6636": 28, "3622": 29, "15068": 30,
            "2431": 31, "2412b": 32, "3039": 33, "15573": 34, "2456": 35, "3040": 36, "3062b": 37, "63864": 38, "99781": 39, "30374": 40,
            "2877": 41, "4032": 42, "87087": 43, "3298": 44, "3034": 45, "18654": 46, "4070": 47, "3040b": 48, "32000": 49, "3700": 50,
            "44728": 51, "60470": 52, "6141": 53, "3032": 54, "60478": 55, "4085d": 56, "14719": 57, "15208": 58, "60470b": 59, "2357": 60,
            "11211": 61, "30136": 62, "26603": 63, "3660": 64, "4286": 65, "2429c01": 66, "6558": 67, "3070b": 68, "63868": 69, "25269": 70,
            "18651": 71, "43093": 72, "3035": 73, "3045": 74, "32062": 75, "48336": 76, "99207": 77, "22885": 78, "3069": 79, "32054": 80,
            "32064": 81, "3665": 82, "4162": 83, "4274": 84, "3705": 85, "6587": 86, "30503": 87, "85969": 88, "2450": 89, "4150": 90,
            "3701": 91, "2445": 92, "3941": 93, "32140": 94, "2432": 95, "48729b": 96, "93273": 97, "32013": 98, "60596": 99, "60897": 100,
            "87079": 101, "3706": 102, "60477": 103, "30414": 104, "3794b": 105, "2555": 106, "15712": 107, "3006": 108, "2357": 109, "32009": 110,
            "41678": 111, "63965": 112, "32523": 113, "32073": 114, "99780": 115, "4519": 116, "2458": 117, "6536": 118, "32316": 119, "32270": 120,
            "2436": 121, "2817": 122, "11458": 123, "2540": 124, "3029": 125, "18674": 126, "32524": 127, "41539": 128, "6632": 129, "32184": 130,
            "41770": 131, "2423": 132, "2419": 133, "85080": 134, "22889": 135, "32039": 136, "32525": 137, "3702": 138, "4265c": 139, "3036": 140,
            "32015": 141, "32034": 142, "60592": 143, "61332": 144, "24866": 145, "32123": 146, "41769": 147, "30565": 148, "24307": 149, "24299": 150,
            "2449": 151, "48989": 152, "41740": 153, "42003": 154, "92907": 155, "3707": 156, "2460": 157, "32014": 158, "3737": 159, "2453": 160,
            "2465": 161, "6538c": 162, "44709": 163, "49307": 164, "4740": 165, "2654": 166, "3031": 167, "3033": 168, "4733": 169, "87580": 170,
            "26601": 171, "41239": 172, "32271": 173, "32556": 174, "61903": 175, "2569": 176, "3063": 177, "3937": 178, "3938": 179, "43857": 180,
            "40359": 181, "40358": 182, "6091": 183, "24121": 184, "32449": 185, "32269": 186, "32016": 187, "4185": 188, "2489": 189, "2496": 190,
            "4211": 191, "4216": 192, "3829c01": 193, "30357": 194, "24309": 195, "24316": 196, "32002": 197, "32019": 198, "61780": 199, "60481": 200,
            "3659": 201, "3043": 202, "3048": 203, "3044": 204, "36840": 205, "13547": 206, "2921": 207, "53451": 208, "54383": 209, "54384": 210,
            "43722": 211, "43723": 212, "29119": 213, "29120": 214, "41751": 215, "32278": 216, "32291": 217, "62462": 218, "6589": 219, "6629": 220,
            "41677": 221, "32498": 222, "30377": 223, "2825": 224, "32012": 225, "32018": 226, "32138": 227, "42127": 228, "30137": 229, "24855": 230,
            "15458": 231, "35397": 232, "3839b": 233, "3680": 234, "3679": 235, "3713": 236, "6590": 237, "3749": 238, "32005": 239, "32177": 240,
            "11478": 241, "15070": 242, "36841": 243, "36842": 244, "61678": 245, "11153": 246, "61409": 247, "32001": 248, "32249": 249, "32348": 250,
            "32526": 251, "4019": 252, "42003": 253, "32192": 254, "15100": 255, "6553": 256, "32200": 257, "32202": 258, "6541": 259, "44294": 260,
            "32056": 261, "32235": 262, "32324": 263, "15461": 264, "6183": 265, "6096": 266, "6064": 267, "61485": 268, "63869": 269, "92438": 270,
            "20482": 271, "3176": 272, "2417": 273, "32198": 274, "18947": 275, "32136": 276, "60593": 277, "60601": 278, "40379": 279, "30153": 280,
            "2494": 281, "4345": 282, "4346": 283, "3007": 284, "14769": 285, "4158": 286, "4162": 287, "4176": 288, "2476": 289, "2462": 290,
            "2577": 291, "4185": 292, "27925": 293, "3027": 294, "3028": 295, "3030": 296, "3035": 297, "3036": 298, "3460": 299, "3665": 300,
            "3660": 301, "3673": 302, "3703": 303, "3738": 304, "3794": 305, "3899": 306, "3933": 307, "3934": 308, "3956": 309, "3957": 310,
            "3959": 311, "3960": 312, "3962": 313, "4032b": 314, "4079": 315, "4081b": 316, "4083": 317, "41740": 318, "41764": 319, "41765": 320,
            "41767": 321, "41768": 322, "42446": 323, "42929": 324, "4304": 325, "4315": 326, "43710": 327, "43711": 328, "43712": 329, "43719": 330,
            "43720": 331, "43721": 332, "44300": 333, "44301": 334, "44302": 335, "44567": 336, "4477": 337, "44809": 338, "44822": 339, "44860": 340,
            "44861": 341, "4490": 342, "4510": 343, "4528": 344, "4532": 345, "4533": 346, "4536": 347, "4588": 348, "4589": 349, "4589b": 350,
            "4592": 351, "4592c02": 352, "4593": 353, "4594": 354, "4595": 355, "4598": 356, "4599": 357, "4599b": 358, "4623": 359, "4697b": 360
        };

        // 建立反向索引
        window.rankToPartMap = {};
        Object.entries(window.partRanks).forEach(([id, rank]) => {
            window.rankToPartMap[rank] = id;
        });

        async function initApp() {
            if (!auth) return;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-cloud text-green-500"></i>';
                    startSync(user);
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        function startSync(user) {
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            onSnapshot(collRef, (snapshot) => {
                const newMappings = {};
                const newIndex = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let drawers = [];
                    if (Array.isArray(data.drawers)) drawers = data.drawers;
                    else if (data.drawer_id) drawers = [data.drawer_id];
                    
                    const partData = {
                        drawers: drawers,
                        name: data.part_name || "",
                        img: data.img_url || "" 
                    };

                    if (drawers.length > 0) {
                        newMappings[doc.id] = partData;
                        newIndex.push({
                            id: doc.id,
                            name: partData.name,
                            img: partData.img,
                            drawers: drawers,
                            type: 'inventory',
                            searchStr: `${doc.id} ${partData.name}`.toLowerCase()
                        });
                    }
                });
                window.mappings = newMappings;
                window.inventoryIndex = newIndex;

                if (currentPartId) checkAndDisplayDrawer(currentPartId);
                
                // [修正] 自動刷新目前開啟的抽屜視窗
                if (!document.getElementById('drawer-modal').classList.contains('hidden') && currentViewingDrawer) {
                    openDrawerContent(currentViewingDrawer);
                }
            });
        }

        // --- Database Actions ---
        window.saveMappingCloud = async (partId, drawerId, partName, imgUrl, mode = 'append') => {
            if (!db) return;
            const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
            try {
                const docSnap = await getDoc(docRef);
                if (mode === 'move') { 
                    const oldData = docSnap.exists() ? docSnap.data() : {};
                    await (docSnap.exists() ? updateDoc : setDoc)(docRef, {
                        part_id: partId,
                        drawers: [drawerId], 
                        part_name: partName || oldData.part_name || "",
                        img_url: imgUrl ? imgUrl : (oldData.img_url || ""),
                        updated_at: new Date().toISOString()
                    });
                } else { 
                    if (docSnap.exists()) {
                        await updateDoc(docRef, {
                            drawers: arrayUnion(drawerId),
                            part_name: partName || docSnap.data().part_name,
                            img_url: imgUrl ? imgUrl : docSnap.data().img_url,
                            updated_at: new Date().toISOString()
                        });
                    } else {
                        await setDoc(docRef, {
                            part_id: partId,
                            drawers: [drawerId],
                            part_name: partName,
                            img_url: imgUrl || "",
                            updated_at: new Date().toISOString()
                        });
                    }
                }
            } catch (e) {
                alert("儲存失敗: " + e.message);
                throw e;
            }
        };

        window.removeMappingCloud = async (partId, drawerIdToRemove) => {
            if (!db) return;
            try {
                const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
                await updateDoc(docRef, { drawers: arrayRemove(drawerIdToRemove) });
            } catch (e) { alert("刪除失敗"); }
        };

        window.clearAllCloudData = async () => {
            if (!db || !confirm("【嚴重警告】確定要清空所有資料嗎？") || !confirm("再次確認：此操作無法復原！")) return;
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            const snapshot = await getDocs(collRef);
            const batchSize = 500;
            let batch = writeBatch(db);
            let count = 0;
            for (const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= batchSize) { await batch.commit(); batch = writeBatch(db); count = 0; }
            }
            if (count > 0) await batch.commit();
            alert("已清空資料庫");
            toggleSettings();
        };

        // --- Keypad System ---
        window.closeKeypad = () => {
            const modal = document.getElementById('keypad-modal');
            const content = document.getElementById('keypad-content');
            content.classList.add('translate-y-full');
            document.getElementById('main-content').classList.remove('pb-keypad');
            setTimeout(() => {
                modal.classList.add('hidden');
                currentKeypadTarget = null;
            }, 300);
        };

        window.openDrawerJumpKeypad = () => {
            const modal = document.getElementById('keypad-modal');
            if (!modal.classList.contains('hidden') && currentKeypadTarget === 'global-jump-input') {
                closeKeypad();
                return;
            }
            const inp = document.getElementById('global-jump-input');
            inp.value = "";
            openKeypad('global-jump-input');
        };

        // [NEW] Open Rank Jump Keypad
        window.openRankJumpKeypad = () => {
            const modal = document.getElementById('keypad-modal');
            if (!modal.classList.contains('hidden') && currentKeypadTarget === 'global-rank-jump-input') {
                closeKeypad();
                return;
            }
            const inp = document.getElementById('global-rank-jump-input');
            inp.value = "";
            openKeypad('global-rank-jump-input');
        };

        window.openKeypad = (id) => { 
            currentKeypadTarget = id; 
            const modal = document.getElementById('keypad-modal'); 
            const content = document.getElementById('keypad-content'); 
            
            const preview = document.getElementById('keypad-preview');
            const targetInput = document.getElementById(id);
            if(preview && targetInput) preview.innerText = targetInput.value;

            modal.classList.remove('hidden'); 
            requestAnimationFrame(() => {
                content.classList.remove('translate-y-full');
            });
            
            if(id !== 'global-jump-input' && id !== 'global-rank-jump-input') {
                document.getElementById('main-content').classList.add('pb-keypad'); 
                setTimeout(() => {
                    const el = document.getElementById(id);
                    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
                }, 300); 
            }
        };

        window.k = (key) => { 
            let inp = null;
            if(currentKeypadTarget === 'jump-drawer-input' || currentKeypadTarget === 'batch-drawer-input') {
                if(key==='del') keypadInputValue = keypadInputValue.slice(0,-1); 
                else if(key==='clr') keypadInputValue = ''; 
                else if(key==='ok') { confirmKeypad(); return; }
                else keypadInputValue += key;
                
                if(currentKeypadTarget === 'jump-drawer-input') {
                    const span = document.getElementById('drawer-modal-title');
                    if(span) span.innerText = keypadInputValue || "-";
                    inp = document.getElementById('jump-drawer-input');
                } else {
                    inp = document.getElementById('batch-drawer-input');
                }
                
                if(inp) inp.value = keypadInputValue;
                return;
            }
            
            inp = document.getElementById(currentKeypadTarget); 
            if(!inp) return; 
            
            let newVal = inp.value;
            if(key === 'del') {
                newVal = newVal.slice(0, -1); 
            } else if(key === 'clr') {
                newVal = ''; 
            } else if(key === 'ok') { 
                confirmKeypad(); 
                return; 
            } else {
                if(newVal.length < 5) newVal += key;
            }
            
            inp.value = newVal;
            const preview = document.getElementById('keypad-preview');
            if(preview) preview.innerText = newVal;
        };

        window.confirmKeypad = () => {
             const inp = document.getElementById(currentKeypadTarget);
             if(inp) {
                 let val = inp.value;
                 // 1. Drawer Jump
                 if (currentKeypadTarget === 'global-jump-input') {
                     if (val === "") val = "1";
                     openDrawerContent(val);
                 }
                 // 2. Rank Modal Jump
                 else if (currentKeypadTarget === 'rank-jump-input') {
                    jumpToRank();
                 }
                 // 3. [NEW] Homepage Rank Jump
                 else if (currentKeypadTarget === 'global-rank-jump-input') {
                    const rank = parseInt(val);
                    if(rank && window.rankToPartMap[rank]) {
                        checkAndDisplayDrawer(window.rankToPartMap[rank]);
                    } else {
                        alert("找不到該名次的零件 (僅收錄 Top 360)");
                    }
                 }
             }
             closeKeypad();
        };

        // [NEW] 抽屜內快速新增零件 (支援批次)
        window.quickAddPartsToDrawer = async () => {
            const input = document.getElementById('drawer-quick-input');
            const val = input.value.trim();
            if(!val) return;
            
            // 處理批次輸入 (空格或逗號分隔)
            const ids = val.split(/[\s,]+/).filter(x => x);
            if(ids.length === 0) return;

            const btn = document.getElementById('drawer-add-btn');
            const orgHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const targetDrawer = currentViewingDrawer; 
                
                for(const id of ids) {
                    // 嘗試取得名稱與圖片
                    let name = "", img = "";
                    const local = window.mappings[id];
                    const cat = window.catalogIndex.find(c => c.id == id);
                    
                    if(local) { name = local.name; img = local.img; }
                    else if(cat) { name = cat.name; }
                    
                    if(!img) img = `https://cdn.rebrickable.com/media/parts/ldraw/0/${id}.png`;
                    
                    // 寫入資料庫 (Append 模式)
                    await window.saveMappingCloud(id, targetDrawer, name, img, 'append');
                }
                
                // 成功回饋
                input.value = "";
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                
                setTimeout(() => {
                    btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.innerHTML = orgHtml;
                    btn.disabled = false;
                }, 1000);
                
            } catch(e) {
                alert("新增失敗: " + e.message);
                btn.innerHTML = orgHtml;
                btn.disabled = false;
            }
        };

        // ------------------ NEW: Camera Reset UI Logic ------------------
        window.resetPreview = () => {
            document.getElementById('preview-img').src = "";
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('retake-hint').classList.add('hidden');
            document.getElementById('cam-buttons').classList.remove('hidden'); // Ensure buttons are back
        };

        initApp();
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pb-keypad { padding-bottom: 400px !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .suggestion-item.active { background-color: #ebf8ff; border-left: 4px solid #3b82f6; }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-cubes mr-2"></i>樂高管家</h1>
            <div class="flex items-center space-x-4">
                <div id="cloud-status" class="text-xs">...</div>
                <button onclick="toggleSettings()" class="hover:text-blue-200"><i class="fa-solid fa-gear text-xl"></i></button>
            </div>
        </div>
    </header>

    <main id="main-content" class="flex-grow p-4 max-w-md mx-auto w-full pb-24 transition-all relative">
        
        <div class="bg-white p-6 rounded-xl shadow-lg text-center mb-6 relative z-30">
            
            <div class="mb-4 relative">
                <div id="preview-container" class="w-full h-40 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden relative">
                    
                    <div class="flex gap-8 z-10" id="cam-buttons">
                        <button onclick="startCamera()" class="flex flex-col items-center justify-center text-gray-400 hover:text-blue-600 transition group">
                            <div class="w-14 h-14 bg-white rounded-2xl shadow-sm border border-gray-200 flex items-center justify-center mb-2 group-hover:border-blue-400 group-hover:scale-105 transition">
                                <i class="fa-solid fa-video text-2xl text-blue-400"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-500">網頁相機</span>
                        </button>

                        <button onclick="document.getElementById('camera-input').click()" class="flex flex-col items-center justify-center text-gray-400 hover:text-purple-600 transition group">
                            <div class="w-14 h-14 bg-white rounded-2xl shadow-sm border border-gray-200 flex items-center justify-center mb-2 group-hover:border-purple-400 group-hover:scale-105 transition">
                                <i class="fa-solid fa-camera text-2xl text-purple-400"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-500">原生相機</span>
                        </button>
                    </div>

                    <img id="preview-img" class="absolute inset-0 w-full h-full object-contain hidden bg-gray-100 z-20 cursor-pointer" onclick="resetPreview()" title="點擊重拍" />
                    
                    <div id="retake-hint" class="absolute bottom-2 right-2 z-30 hidden pointer-events-none">
                        <span class="bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-sm">點擊重拍</span>
                    </div>
                </div>
            </div>

            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onclick="this.value=null" onchange="handleImageFile(this.files[0])">

            <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-2"></div>
                <span id="loading-text" class="text-xs text-gray-500">處理中...</span>
            </div>

            <div class="relative">
                <div class="flex gap-2 mb-4">
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                        </div>
                        <input type="text" id="part-id-input" placeholder="輸入零件號碼 (例如 7026)" 
                            class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition outline-none text-lg font-bold font-mono text-gray-700 shadow-sm"
                            oninput="handleInputSearch(this.value)"
                            onkeydown="handleSearchKeydown(event)"
                            onkeypress="if(event.key === 'Enter') manualSearch()">
                    </div>
                    <button onclick="manualSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl font-bold shadow-lg shadow-blue-200 transition active:scale-95 flex items-center">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
                <div id="search-suggestions" class="absolute top-full left-0 right-0 bg-white shadow-xl rounded-b-xl border border-t-0 border-gray-200 max-h-72 overflow-y-auto hidden z-40"></div>
            </div>

            <div class="mt-2 flex justify-between items-center px-1">
                <button onclick="openRankJumpKeypad()" class="text-xs font-bold text-gray-400 flex items-center hover:text-blue-600 transition">
                    <i class="fa-solid fa-trophy mr-1"></i> 查看指定RANK
                </button>
                <button onclick="openDrawerJumpKeypad()" class="text-xs font-bold text-gray-400 flex items-center hover:text-blue-600 transition">
                    <i class="fa-solid fa-box-open mr-1"></i> 查看指定抽屜
                </button>
            </div>

            <input type="hidden" id="global-jump-input">
            <input type="hidden" id="global-rank-jump-input"> </div>

        <div id="result-area" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-lg border-l-4" id="info-card">
                <div class="flex items-start mb-4">
                    <img id="api-img" src="" class="w-20 h-20 object-contain bg-gray-50 rounded border border-gray-200 mr-4 hidden">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h2 class="text-3xl font-black font-mono text-gray-800 leading-none" id="res-part-id">---</h2>
                            <div class="flex flex-col items-end gap-1">
                                <span id="res-source" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">SRC</span>
                                <button id="retry-btn" onclick="retryWithGemini()" class="hidden text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded border border-purple-200 hover:bg-purple-200 transition">
                                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>AI 重試
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1 leading-tight break-words" id="res-part-name">---</p>
                    </div>
                </div>

                <div id="status-exist" class="hidden">
                    <div class="mb-4">
                        <p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">Current Location</p>
                        <div id="drawer-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4" id="exist-actions">
                        <button onclick="showActionPanel('add')" class="bg-blue-50 border border-blue-200 text-blue-700 py-3 rounded-lg font-bold text-sm hover:bg-blue-100 flex justify-center items-center"><i class="fa-solid fa-plus-circle mr-2 text-lg"></i> 新增位置</button>
                        <button onclick="showActionPanel('move')" class="bg-red-50 border border-red-200 text-red-700 py-3 rounded-lg font-bold text-sm hover:bg-red-100 flex justify-center items-center"><i class="fa-solid fa-arrow-right-arrow-left mr-2 text-lg"></i> 移動位置</button>
                    </div>
                </div>

                <div id="status-new" class="hidden">
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-3"><p class="text-yellow-800 font-bold text-sm flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> 尚未登錄，設定新位置：</p></div>
                    <div id="inline-action-panel"></div> 
                </div>

                <div id="dynamic-action-area" class="mt-4 hidden border-t border-gray-100 pt-4"></div>

                <div id="universal-suggestions" class="mt-6 pt-4 border-t-2 border-dashed border-gray-200 hidden">
                    <p class="text-xs font-bold text-gray-500 mb-3 flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1 text-purple-500"></i> 
                        相似零件與建議位置 (點擊套用)：
                    </p>
                    <div id="universal-similar-list" class="space-y-2"></div>
                </div>
            </div>

            <div id="batch-card" class="hidden bg-white p-4 rounded-xl shadow-lg border-l-8 border-indigo-500">
                <div class="flex items-center justify-between mb-4 border-b pb-2">
                    <h2 class="text-xl font-black text-gray-800 flex items-center">
                        <i class="fa-solid fa-layer-group mr-2 text-indigo-500"></i> 批次移動模式
                    </h2>
                    <span class="bg-indigo-100 text-indigo-700 font-bold px-3 py-1 rounded-full text-xs" id="batch-count">0 items</span>
                </div>
                
                <div id="batch-list" class="flex flex-wrap gap-2 mb-4 max-h-60 overflow-y-auto p-1"></div>

                <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-700">全部移動至：</span>
                            <div class="flex items-center gap-2">
                                <input type="text" id="batch-drawer-input" class="w-24 p-2 border-2 border-indigo-500 rounded-lg text-center text-2xl font-black text-indigo-700 bg-white cursor-pointer shadow-inner" readonly onclick="openKeypad('batch-drawer-input')">
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-2">
                             <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="batch-drawer-sub" class="w-5 h-5 accent-indigo-600 rounded">
                                <span class="text-sm font-bold text-gray-500">夾層 a</span>
                            </label>
                        </div>
                        <button onclick="executeBatchAdd()" id="batch-confirm-btn" class="w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-indigo-600 hover:bg-indigo-700 transition active:scale-95 text-lg">
                            <i class="fa-solid fa-check-double mr-2"></i> 確認批次移動
                        </button>
                    </div>
                </div>
            </div>

            <div id="action-panel-template" class="hidden">
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-gray-700" id="action-label">目標抽屜：</span>
                        <div class="flex items-center gap-2">
                             <button onclick="adjustDrawer(-1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-minus"></i></button>
                             <input type="text" id="drawer-input" class="w-24 p-2 border-2 border-blue-500 rounded-lg text-center text-2xl font-black text-blue-700 bg-white cursor-pointer shadow-inner" readonly onclick="openKeypad('drawer-input')">
                             <button onclick="adjustDrawer(1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 mb-1">
                        <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="drawer-sub" class="w-5 h-5 accent-blue-600 rounded"><span class="text-sm font-bold text-gray-500">夾層 a</span></label>
                    </div>
                    <button id="confirm-btn" class="w-full py-3.5 rounded-xl font-bold text-white shadow-md transition-all active:scale-95 text-lg flex justify-center items-center">確認</button>
                </div>
            </div>
        </div>
    </main>

    <div id="drawer-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh] relative">
            <div class="p-4 border-b flex flex-col bg-gray-50 rounded-t-2xl relative">
                <button onclick="closeDrawerModal()" class="absolute top-3 left-3 z-10 w-8 h-8 flex items-center justify-center bg-white border border-gray-200 rounded-full text-gray-500 shadow-sm hover:bg-red-50 hover:text-red-500 transition active:scale-95">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="flex items-center justify-between w-full mt-6">
					<button onclick="navDrawer(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm text-gray-600 hover:text-blue-600 active:scale-95 transition">
						<i class="fa-solid fa-minus"></i>
					</button>
					<div onclick="openDrawerJumpKeypad()" class="flex-1 flex flex-col items-center justify-center cursor-pointer group mx-2 py-1 rounded-lg hover:bg-gray-50 transition active:scale-95">
						<span class="text-3xl font-black text-blue-600 font-mono tracking-tight group-hover:text-blue-700" id="drawer-modal-title">---</span>
						<div class="flex items-center gap-1 text-[10px] text-gray-400 font-bold uppercase tracking-widest group-hover:text-blue-400">
							<i class="fa-solid fa-pen"></i> 點擊跳轉
						</div>
					</div>
					<button onclick="navDrawer(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm text-gray-600 hover:text-blue-600 active:scale-95 transition">
						<i class="fa-solid fa-plus"></i>
					</button>
				</div>
            </div>
            
            <div class="px-4 py-3 bg-gray-50 border-b flex gap-2 items-center">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-plus text-gray-400"></i>
                    </div>
                    <input type="text" id="drawer-quick-input" placeholder="輸入零件碼 (空格分隔批次)" 
                           class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none uppercase shadow-inner"
                           onkeypress="if(event.key === 'Enter') quickAddPartsToDrawer()">
                </div>
                <button id="drawer-add-btn" onclick="quickAddPartsToDrawer()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 active:scale-95 transition">
                    加入
                </button>
            </div>

            <div id="drawer-modal-content" class="p-4 overflow-y-auto grid grid-cols-3 gap-3 bg-gray-50/50"></div>
        </div>
    </div>

    <div id="rank-nav-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-xs shadow-2xl flex flex-col relative overflow-hidden">
            <button onclick="closeRankModal()" class="absolute top-2 left-2 z-20 w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition shadow-sm">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="bg-gray-50 p-3 pl-12 border-b relative overflow-hidden">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col items-center min-w-[3rem]">
                        <h3 class="text-[9px] font-bold text-gray-400 tracking-widest uppercase mb-0.5">RANK</h3>
                        <div class="text-3xl font-black text-gray-800 flex items-baseline leading-none">
                            <span class="text-sm text-gray-300 mr-0.5">#</span>
                            <span id="rank-modal-current">--</span>
                        </div>
                    </div>
                    <div id="rank-modal-drawers" class="flex-1 flex flex-wrap items-center justify-center gap-1 mx-2 h-14 overflow-y-auto content-center"></div>
                    <div class="w-14 h-14 bg-white rounded-lg border border-gray-200 shadow-sm flex items-center justify-center p-1 shrink-0">
                        <img id="rank-modal-img" src="" class="w-full h-full object-contain opacity-50" onerror="this.style.opacity=0">
                    </div>
                </div>
            </div>
            <div class="p-6 flex flex-col gap-4">
                <div class="flex items-center justify-between gap-4">
                    <button onclick="navRank(-1)" class="w-12 h-12 flex items-center justify-center bg-white border-2 border-gray-200 rounded-xl shadow-sm text-gray-600 text-xl hover:border-blue-400 hover:text-blue-600 active:scale-95 transition">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                    <div class="flex-1 text-center">
                        <div class="text-[10px] text-gray-400 font-bold mb-1">PART ID</div>
                        <div id="rank-modal-part-id" class="font-mono font-bold text-lg text-blue-600">---</div>
                    </div>
                    <button onclick="navRank(1)" class="w-12 h-12 flex items-center justify-center bg-white border-2 border-gray-200 rounded-xl shadow-sm text-gray-600 text-xl hover:border-blue-400 hover:text-blue-600 active:scale-95 transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
				<div class="relative">
                    <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-hashtag text-gray-300 text-xs"></i>
                    </div>
                    <input type="text" id="rank-jump-input" placeholder="點擊輸入" 
                           class="w-full pl-8 pr-12 py-2 border rounded-lg text-center font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer caret-transparent"
                           readonly
                           onclick="this.value=''; openKeypad('rank-jump-input')">
                    <button onclick="jumpToRank()" class="absolute inset-y-1 right-1 px-3 bg-blue-100 text-blue-600 rounded font-bold text-xs hover:bg-blue-200">
                        GO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="camera-overlay" class="fixed inset-0 bg-black z-[90] hidden flex flex-col">
        <div class="relative flex-1 bg-black overflow-hidden flex items-center justify-center">
            <video id="camera-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <button onclick="stopCamera()" class="absolute top-4 right-4 text-white w-10 h-10 flex items-center justify-center bg-black/50 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="h-32 bg-black flex items-center justify-center gap-12 pb-6 pt-2">
            <button onclick="document.getElementById('camera-input').click()" class="text-white flex flex-col items-center opacity-80 hover:opacity-100">
                <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center mb-1"><i class="fa-solid fa-image text-lg"></i></div>
                <span class="text-[10px]">相簿</span>
            </button>
            <button onclick="takePhoto()" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 ring-2 ring-white active:scale-95 transition"></button>
            <div class="w-10"></div>
        </div>
    </div>

    <div id="keypad-modal" class="fixed inset-0 z-[100] hidden flex items-end justify-center pointer-events-none">
        <div class="bg-white w-full max-w-md shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl p-5 pointer-events-auto transform transition-transform duration-300 translate-y-full" id="keypad-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-red-50 hover:text-red-500 transition active:scale-95">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <span id="keypad-preview" class="flex-1 text-right text-3xl font-black text-blue-600 font-mono mx-4 min-h-[40px]"></span>
                <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 active:scale-95">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="k('1')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">1</button>
                <button onclick="k('2')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">2</button>
                <button onclick="k('3')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">3</button>
                <button onclick="k('4')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">4</button>
                <button onclick="k('5')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">5</button>
                <button onclick="k('6')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">6</button>
                <button onclick="k('7')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">7</button>
                <button onclick="k('8')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">8</button>
                <button onclick="k('9')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">9</button>
                <button onclick="k('clr')" class="bg-red-50 border-b-4 border-red-200 rounded-xl p-3 text-red-500 text-lg font-bold active:border-b-0 active:translate-y-1 transition-all">清空</button>
                <button onclick="k('0')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">0</button>
                <button onclick="k('ok')" class="bg-blue-600 border-b-4 border-blue-800 rounded-xl p-3 text-white text-xl font-bold active:border-b-0 active:translate-y-1 transition-all">OK</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800">設定</h3>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">Gemini API Key</label><input type="password" id="gemini-key" class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 outline-none"></div>
            <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1">AI Model</label><select id="gemini-model" class="w-full border-2 border-gray-200 rounded-lg p-2 bg-white"><option value="gemini-1.5-flash">1.5 Flash</option><option value="gemini-1.5-pro">1.5 Pro</option><option value="gemini-2.0-flash-exp">2.0 Flash Exp</option></select></div>
            <hr class="border-gray-100 mb-4"><button onclick="window.clearAllCloudData()" class="w-full text-red-500 border border-red-200 bg-red-50 p-3 rounded-lg mb-4 text-sm font-bold hover:bg-red-100 transition">清空所有資料</button>
            <div class="flex justify-end gap-3"><button onclick="toggleSettings()" class="px-5 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">取消</button><button onclick="saveSettings()" class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700">儲存</button></div>
        </div>
    </div>

    <script>
        // State
        let currentPartId = null;
        let currentPartName = "";
        let currentPartImgUrl = "";
        let currentResizedBlob = null;
        let currentKeypadTarget = null;
        let currentAction = 'append'; 
        let videoStream = null; 
        let currentViewingDrawer = null; 
        let keypadInputValue = ""; 
        let currentSuggestions = []; 
        let currentNavRank = 1;
        let currentBatchIds = [];

        let geminiApiKey = localStorage.getItem('lego_gemini_key') || "";
        let geminiModel = localStorage.getItem('lego_gemini_model') || "gemini-1.5-flash";
        let selectedSuggestionIndex = -1;

        if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));

        // Camera
        window.startCamera = async () => {
            try {
                const constraints = { video: { facingMode: { ideal: "environment" } } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-video');
                video.srcObject = stream;
                videoStream = stream;
                document.getElementById('camera-overlay').classList.remove('hidden');
                video.play().catch(e => console.log(e));
            } catch (err) {
                console.error(err);
                alert("無法啟動相機，請檢查權限或使用相簿上傳。\n" + err.message);
                document.getElementById('camera-input').click();
            }
        };

        window.stopCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('camera-overlay').classList.add('hidden');
        };

        window.takePhoto = () => {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => { stopCamera(); processBlob(blob); }, 'image/jpeg', 0.9);
        };

        window.handleImage = (input) => { if (input.files[0]) handleImageFile(input.files[0]); };
        window.handleImageFile = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            processBlob(file);
        };

        async function processBlob(blob) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('loading-text').innerText = "處理中...";

            try {
                const resizedBlob = await resizeImage(blob);
                currentResizedBlob = resizedBlob; 
                
                const previewImg = document.getElementById('preview-img');
                if(!previewImg.src || previewImg.classList.contains('hidden')) {
                     const url = URL.createObjectURL(resizedBlob);
                     previewImg.src = url;
                     previewImg.classList.remove('hidden');
                }
                
                // [NEW] 拍照後自動隱藏按鈕，顯示重拍提示
                document.getElementById('cam-buttons').classList.add('hidden');
                document.getElementById('retake-hint').classList.remove('hidden');

                let result = await tryBrickognize(resizedBlob);
                if (!result) {
                    if (geminiApiKey) {
                        document.getElementById('loading-text').innerText = "Brickognize 無結果，切換至 Gemini AI...";
                        result = await tryGemini(resizedBlob);
                    } else { throw new Error("Brickognize 無結果且未設定 API Key"); }
                }
                
                currentPartName = result.name;
                currentPartImgUrl = result.img;
                document.getElementById('part-id-input').value = result.id;
                
                const srcBadge = document.getElementById('res-source');
                if(srcBadge) {
                    srcBadge.textContent = result.source;
                    srcBadge.className = `text-[10px] px-2 py-0.5 rounded font-bold text-white ${result.source==='Brickognize'?'bg-green-500':'bg-purple-500'}`;
                }

                checkAndDisplayDrawer(result.id);
                
                const retryBtn = document.getElementById('retry-btn');
                if(retryBtn) retryBtn.classList.remove('hidden');

            } catch (e) { 
                alert(e.message); 
            } finally { 
                document.getElementById('loading').classList.add('hidden'); 
            }
        }

        // Search
        window.manualSearch = (preserveState = false) => {
            const input = document.getElementById('part-id-input');
            const rawValue = input.value.trim();
            if (!rawValue) return;

            const ids = rawValue.split(/[\s,]+/).filter(id => id.length > 0);

            if (ids.length > 1) {
                handleBatchMode(ids);
            } else {
                if (!preserveState) {
                    currentPartName = "";
                    currentPartImgUrl = ""; 
                    currentResizedBlob = null; 
                    const retryBtn = document.getElementById('retry-btn');
                    if(retryBtn) retryBtn.classList.add('hidden');
                    const srcBadge = document.getElementById('res-source');
                    if(srcBadge) {
                        srcBadge.textContent = "MANUAL";
                        srcBadge.className = "text-[10px] px-2 py-0.5 rounded bg-gray-500 text-white font-bold";
                    }
                }
                
                if(typeof closeKeypad === 'function') closeKeypad();
                const sugBox = document.getElementById('search-suggestions');
                if(sugBox) sugBox.classList.add('hidden');
                document.getElementById('batch-card').classList.add('hidden');
                
                checkAndDisplayDrawer(ids[0]);
            }
        };

        window.handleBatchMode = (ids) => {
            document.getElementById('info-card').parentElement.classList.remove('hidden'); 
            document.getElementById('info-card').classList.add('hidden');
            document.getElementById('status-exist').classList.add('hidden');
            document.getElementById('status-new').classList.add('hidden');
            document.getElementById('batch-card').classList.remove('hidden');
            
            if(typeof closeKeypad === 'function') closeKeypad();
            document.getElementById('search-suggestions').classList.add('hidden');

            document.getElementById('batch-count').innerText = `${ids.length} 個零件`;

            const listContainer = document.getElementById('batch-list');
            listContainer.innerHTML = ids.map(id => {
                let name = "未命名";
                const localData = (window.mappings || {})[id];
                const catData = window.catalogIndex ? window.catalogIndex.find(c => c.id == id) : null;
                
                if (localData && localData.name) name = localData.name;
                else if (catData) name = catData.name;

                let imgUrl = localData?.img || `https://cdn.rebrickable.com/media/parts/ldraw/0/${id}.png`;

                return `
                    <div class="flex items-center gap-2 bg-gray-50 border border-indigo-100 p-2 rounded-lg w-[48%] flex-grow">
                        <img src="${imgUrl}" class="w-8 h-8 object-contain bg-white rounded border" onerror="this.style.opacity=0">
                        <div class="min-w-0">
                            <div class="font-bold text-xs font-mono text-indigo-700">${id}</div>
                            <div class="text-[10px] text-gray-400 truncate w-20">${name}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const drawerInput = document.getElementById('batch-drawer-input');
            drawerInput.value = getNextEmptyDrawerId();
            
            window.currentBatchIds = ids;
        };

        window.executeBatchAdd = async () => {
            const ids = window.currentBatchIds || [];
            if (ids.length === 0) return;

            const drawerNum = document.getElementById('batch-drawer-input').value;
            const isSub = document.getElementById('batch-drawer-sub').checked;
            const targetDrawer = isSub ? `${drawerNum}a` : `${drawerNum}`;
            
            const btn = document.getElementById('batch-confirm-btn');
            const originalHtml = btn.innerHTML;
            
            if (!drawerNum) { alert("請輸入抽屜號碼"); return; }
            
            if (!confirm(`確定將這 ${ids.length} 個零件全部「移動」到 [ ${targetDrawer} ] 嗎？\n\n注意：這會「取消」這些零件原本所在的抽屜號碼！`)) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';

            try {
                for (const id of ids) {
                    let name = "";
                    let img = "";
                    
                    const localData = (window.mappings || {})[id];
                    const catData = window.catalogIndex ? window.catalogIndex.find(c => c.id == id) : null;

                    if (localData) { name = localData.name; img = localData.img; }
                    else if (catData) { name = catData.name; }
                    
                    if (!img) img = `https://cdn.rebrickable.com/media/parts/ldraw/0/${id}.png`;

                    await window.saveMappingCloud(id, targetDrawer, name, img, 'move');
                }

                btn.className = "w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-green-500 transition-all";
                btn.innerHTML = '<i class="fa-solid fa-check"></i> 移動完成';
                
                setTimeout(() => {
                    btn.className = "w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-indigo-600 hover:bg-indigo-700 transition active:scale-95 text-lg";
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    
                    document.getElementById('part-id-input').value = "";
                    document.getElementById('result-area').classList.add('hidden');
                    document.getElementById('batch-card').classList.add('hidden');
                    
                    if(window.currentPartId) checkAndDisplayDrawer(window.currentPartId);
                    
                    alert("批次移動成功！");
                }, 1500);

            } catch (e) {
                console.error(e);
                alert("批次處理過程中發生錯誤：" + e.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        };

        window.handleInputSearch = (value) => {
            selectedSuggestionIndex = -1;
            const suggestionsBox = document.getElementById('search-suggestions');
            if (!value || value.length < 1) { suggestionsBox.classList.add('hidden'); return; }
            
            const cleanValue = value.replace(/[^\w\s\u4e00-\u9fa5]/g, ' ').trim();
            const terms = cleanValue.toLowerCase().split(/\s+/).filter(t => t.length > 0);
            
            const inventoryMatches = window.inventoryIndex.map(item => calculateScore(item, value, terms)).filter(i => i.score > 0);
            const existingIds = new Set(window.inventoryIndex.map(i => i.id));
            const catalogMatches = window.catalogIndex.filter(item => !existingIds.has(item.id)).map(item => calculateScore({...item, type: 'catalog'}, value, terms)).filter(i => i.score > 0);
            const allMatches = [...inventoryMatches, ...catalogMatches];
            allMatches.sort((a, b) => b.score - a.score);
            const topMatches = allMatches.slice(0, 12);
            
            window.currentSuggestions = topMatches;

            if (topMatches.length > 0) {
                suggestionsBox.innerHTML = topMatches.map((m, index) => {
                    const highlightedName = highlightText(m.name, value);
                    const highlightedId = highlightText(m.id, value);
                    let badgeHtml = m.type === 'inventory' ? `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold ml-2">${parseInt(m.drawers[0].toString().replace('a','')) > 477 ? `📦 夾鏈袋 ${m.drawers[0]}` : `抽屜 ${m.drawers[0]}`}</span>` : `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-bold ml-2"><i class="fa-solid fa-book-open mr-1"></i>字典</span>`;
                    return `<div id="suggestion-${index}" class="suggestion-item flex items-center p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 transition-colors" onclick="selectSuggestionByIndex(${index})">${m.img?`<img src="${m.img}" class="w-10 h-10 object-contain mr-3 bg-gray-50 rounded border">`:'<div class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center"><i class="fa-solid fa-cube text-gray-300"></i></div>'}<div class="overflow-hidden flex-1"><div class="font-bold font-mono text-blue-600 flex items-center"><span>${highlightedId}</span>${badgeHtml}</div><div class="text-xs text-gray-500 truncate mt-0.5">${highlightedName}</div></div></div>`;
                }).join('');
                suggestionsBox.classList.remove('hidden');
            } else { suggestionsBox.classList.add('hidden'); }
        };

        function calculateScore(item, value, terms) {
            let score = 0; 
            const idLower = item.id.toLowerCase();
            const rawValueLower = value.toLowerCase();
            if (idLower === rawValueLower) score += 100;
            else if (idLower.startsWith(rawValueLower)) score += 80;
            else if (idLower.includes(rawValueLower)) score += 20;

            let matchCount = 0;
            terms.forEach(term => {
                if (item.searchStr.includes(term)) matchCount++;
            });

            if (matchCount > 0) {
                score += 10;
                score += (matchCount / terms.length) * 50; 
                if (item.name.toLowerCase().startsWith(terms[0])) score += 30;
            }

            if (score === 0) return { score: 0 };
            return { ...item, score };
        }

        function highlightText(text, query) {
            if(!query) return text;
            const cleanQuery = query.replace(/[^\w\s\u4e00-\u9fa5]/g, ' ').trim();
            const terms = cleanQuery.split(/\s+/).filter(t => t.length > 0);
            let result = text;
            terms.forEach(term => {
                if(term.length > 0) {
                    const regex = new RegExp(`(${term})`, 'gi');
                    result = result.replace(regex, '<span class="bg-yellow-200 text-gray-900 font-bold">$1</span>');
                }
            });
            return result;
        }

        window.selectSuggestionByIndex = (index) => {
            const m = window.currentSuggestions[index];
            if(m) selectSuggestion(m.id, m.type, m.name);
        };

        window.selectSuggestion = (id, type, name) => { 
            document.getElementById('part-id-input').value = id; 
            document.getElementById('search-suggestions').classList.add('hidden'); 
            if (type === 'catalog') { 
                currentPartName = name; 
                document.getElementById('res-source').textContent = "CATALOG"; 
                document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-gray-500 text-white font-bold"; 
                manualSearch(true);
            } else {
                manualSearch(false);
            }
        };

        window.handleSearchKeydown = (e) => { 
            const box = document.getElementById('search-suggestions'); 
            if (box.classList.contains('hidden')) return; 
            const items = box.querySelectorAll('.suggestion-item'); 
            if (items.length === 0) return; 
            if (e.key === 'ArrowDown') { 
                e.preventDefault(); 
                selectedSuggestionIndex++; 
                if (selectedSuggestionIndex >= items.length) selectedSuggestionIndex = 0; 
                updateSelectionStyle(items); 
                items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'}); 
            } else if (e.key === 'ArrowUp') { 
                e.preventDefault(); 
                selectedSuggestionIndex--; 
                if (selectedSuggestionIndex < 0) selectedSuggestionIndex = items.length - 1; 
                updateSelectionStyle(items); 
                items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'}); 
            } else if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (selectedSuggestionIndex > -1) items[selectedSuggestionIndex].click(); 
                else { manualSearch(); box.classList.add('hidden'); } 
            } else if (e.key === 'Escape') { 
                box.classList.add('hidden'); 
            } 
        };
        
        function updateSelectionStyle(items) { 
            items.forEach((item, idx) => { 
                if (idx === selectedSuggestionIndex) item.classList.add('active'); 
                else item.classList.remove('active'); 
            }); 
        }

        // Logic
        function checkAndDisplayDrawer(partId) {
            currentPartId = partId;
            const partData = (window.mappings || {})[partId];
            const drawers = partData ? partData.drawers : [];
            
            let displayName = currentPartName;
            if (!displayName && partData && partData.name) displayName = partData.name;
            if (!displayName && window.catalogIndex) {
                const catItem = window.catalogIndex.find(c => c.id == partId);
                if (catItem) displayName = catItem.name;
            }
            if (displayName) currentPartName = displayName;

            document.getElementById('res-part-id').textContent = partId;
            document.getElementById('res-part-name').textContent = displayName || "未命名零件";
            
            const img = document.getElementById('api-img');
            let url = currentPartImgUrl || partData?.img;
            if (!url) {
                url = `https://cdn.rebrickable.com/media/parts/ldraw/0/${partId}.png`;
            }
            img.src = url; 
            img.classList.remove('hidden');
            img.onerror = function() { this.style.display = 'none'; };
            img.style.display = 'block';
            
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('batch-card').classList.add('hidden'); // Ensure batch card is hidden

            const category = window.getLegoCategory(partId, displayName || "");
            const sourceBadge = document.getElementById('res-source');
            sourceBadge.textContent = category;
            
            if (category.startsWith("BASIC")) {
                sourceBadge.className = "text-[10px] px-2 py-0.5 rounded bg-blue-600 text-white font-bold uppercase tracking-wider shadow-sm";
            } else if (category.startsWith("TECHNIC")) {
                sourceBadge.className = "text-[10px] px-2 py-0.5 rounded bg-gray-600 text-white font-bold uppercase tracking-wider shadow-sm";
            } else {
                sourceBadge.className = "text-[10px] px-2 py-0.5 rounded bg-purple-500 text-white font-bold uppercase tracking-wider shadow-sm";
            }

            let rankBadge = document.getElementById('res-rank-badge');
            if (!rankBadge) {
                const parent = sourceBadge.parentElement;
                rankBadge = document.createElement('div');
                rankBadge.id = 'res-rank-badge';
                rankBadge.className = "mt-2 flex flex-col items-end hidden"; 
                parent.appendChild(rankBadge);
            }
            const rank = window.partRanks ? window.partRanks[partId.toString()] : null;
            if (rank) {
                rankBadge.innerHTML = `
                    <div onclick="openRankModal(${rank})" class="border-2 border-gray-300 rounded-lg p-1 min-w-[3rem] flex flex-col items-center justify-center bg-gray-50 cursor-pointer hover:border-blue-400 hover:bg-blue-50 hover:scale-105 transition group" title="點擊開啟排名導航">
                        <span class="text-[8px] text-gray-400 font-bold leading-none mb-0.5 group-hover:text-blue-400">RANK</span>
                        <span class="text-lg font-black text-gray-700 leading-none font-mono group-hover:text-blue-600">${rank}</span>
                    </div>`;
                rankBadge.classList.remove('hidden');
            } else {
                rankBadge.classList.add('hidden');
            }

            if(drawers.length > 0) {
                document.getElementById('status-exist').classList.remove('hidden');
                document.getElementById('status-new').classList.add('hidden');
                document.getElementById('dynamic-action-area').classList.add('hidden');
                document.getElementById('exist-actions').classList.remove('hidden');
                document.getElementById('info-card').className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-green-500 transition-all"; 
                document.getElementById('info-card').classList.remove('hidden'); // Ensure info card is shown
                
                document.getElementById('drawer-list').innerHTML = drawers.map(d => {
                    const num = parseInt(d.toString().replace('a',''));
                    const label = num > 477 ? `<i class="fa-solid fa-bag-shopping mr-1"></i>夾鏈袋 ${d}` : `<i class="fa-solid fa-box-open mr-1"></i>抽屜 ${d}`;
                    const bgClass = num > 477 ? "bg-purple-100 text-purple-800 border-purple-200" : "bg-green-50 text-green-800 border-green-200";
                    return `<div class="${bgClass} border px-3 py-1.5 rounded-lg font-bold shadow-sm flex items-center text-sm"><span onclick="openDrawerContent('${d.toString().replace('a','')}')" class="cursor-pointer flex items-center hover:underline">${label}</span><button onclick="removeLoc('${d}')" class="ml-3 w-5 h-5 flex items-center justify-center bg-white rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 shadow-sm transition"><i class="fa-solid fa-xmark text-xs"></i></button></div>`;
                }).join('');
            } else {
                document.getElementById('status-exist').classList.add('hidden');
                document.getElementById('status-new').classList.remove('hidden');
                document.getElementById('info-card').className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-yellow-400 transition-all"; 
                document.getElementById('info-card').classList.remove('hidden'); // Ensure info card is shown
                setupActionPanel('add', document.getElementById('inline-action-panel'));
                const inp = document.getElementById('drawer-input-active'); 
                if(inp) inp.value = getNextEmptyDrawerId();
            }

            const uniContainer = document.getElementById('universal-suggestions');
            const uniList = document.getElementById('universal-similar-list');
            const suggestions = findSimilarParts(displayName || "");
            
            if (suggestions.length > 0) {
                uniList.innerHTML = suggestions.map(s => {
                    const dNum = parseInt(s.drawers[0].toString().replace('a',''));
                    const locLabel = dNum > 477 ? `夾鏈袋 ${s.drawers[0]}` : `抽屜 ${s.drawers[0]}`;
                    const cat = window.getLegoCategory(s.id, s.name);
                    const imgHtml = s.img ? 
                        `<img src="${s.img}" onclick="event.stopPropagation(); selectPartFromDrawer('${s.id}')" class="w-10 h-10 object-contain rounded border mr-3 bg-gray-50 cursor-pointer hover:ring-2 hover:ring-blue-400 transition" title="點擊跳轉至此零件">` : 
                        `<div onclick="event.stopPropagation(); selectPartFromDrawer('${s.id}')" class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-blue-400 transition" title="點擊跳轉至此零件"><i class="fa-solid fa-cube text-gray-400"></i></div>`;

                    return `<div class="flex items-center p-2 bg-white border border-purple-100 rounded-lg cursor-pointer hover:bg-purple-50 transition shadow-sm group">
                        ${imgHtml}
                        <div class="flex-1 min-w-0" onclick="useSuggestedDrawer('${s.drawers[0]}')">
                            <div class="flex items-center gap-2">
                                <div class="text-xs font-bold text-gray-700 truncate">${s.name}</div>
                                <span class="text-[8px] bg-gray-100 text-gray-500 px-1 rounded border">${cat}</span>
                            </div>
                            <div class="text-[10px] text-gray-500 font-mono">ID: ${s.id}</div>
                        </div>
                        <span onclick="event.stopPropagation(); openDrawerContent('${s.drawers[0].toString().replace('a','')}')" class="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded group-hover:bg-purple-200 transition hover:underline hover:scale-105 transform">${locLabel}</span>
                    </div>`;
                }).join('');
                uniContainer.classList.remove('hidden');
            } else {
                uniContainer.classList.add('hidden');
            }
        }

        function getNextEmptyDrawerId() { const used = new Set(); Object.values(window.mappings || {}).forEach(d => { if(d.drawers) d.drawers.forEach(dr => used.add(dr.toString().replace('a',''))); }); for(let i=1; i<=9999; i++) if(!used.has(i.toString())) return i; return 1; }
        function levenshtein(a,b){if(a.length===0)return b.length;if(b.length===0)return a.length;var matrix=[];for(var i=0;i<=b.length;i++)matrix[i]=[i];for(var j=0;j<=a.length;j++)matrix[0][j]=j;for(var i=1;i<=b.length;i++){for(var j=1;j<=a.length;j++){if(b.charAt(i-1)==a.charAt(j-1))matrix[i][j]=matrix[i-1][j-1];else matrix[i][j]=Math.min(matrix[i-1][j-1]+1,Math.min(matrix[i][j-1]+1,matrix[i-1][j]+1))}}return matrix[b.length][a.length]}
        
        // --- 優化版：相似零件推薦演算法 (加入分類權重) ---
        function findSimilarParts(targetName) {
            if (!targetName) return [];
            
            const targetId = currentPartId || "";
            const targetCategory = window.getLegoCategory(targetId, targetName);
            const targetMainCat = targetCategory.split('-')[0]; // 例如 "TECHNIC-beam" 取 "TECHNIC"
            
            const candidates = [];
            const targetLower = targetName.toLowerCase();

            // 遍歷 Firebase 同步下來的庫存資料
            Object.entries(window.mappings).forEach(([id, data]) => {
                // 1. 排除自己
                if (id === targetId) return;
                
                if (data.name && data.drawers.length > 0) {
                    const nameLower = data.name.toLowerCase();
                    const itemCategory = window.getLegoCategory(id, data.name);
                    const itemMainCat = itemCategory.split('-')[0];

                    // --- 分數計算開始 ---
                    let score = 0;

                    // A. 文字相似度 (Levenshtein) - 基礎分 0~100
                    const dist = levenshtein(targetLower, nameLower);
                    const maxLen = Math.max(targetLower.length, nameLower.length);
                    // 轉換為相似度分數 (距離越小，分數越高)
                    const similarity = (1 - dist / maxLen) * 100;
                    score += similarity;

                    // B. 分類加權 (Category Boost) - 這是優化核心！
                    if (itemCategory === targetCategory) {
                        score += 150; // 細分類相同 (例如都是 TECHNIC-beam) -> 超級優先
                    } else if (itemMainCat === targetMainCat) {
                        score += 80;  // 主分類相同 (例如都是 TECHNIC) -> 優先
                    } else if (itemMainCat === 'BASIC' && targetMainCat === 'BASIC') {
                        score += 30;  // 都是基本磚 -> 稍微優先
                    }

                    // C. 關鍵字加權
                    if (targetLower.includes("plate") && nameLower.includes("plate")) score += 20;
                    if (targetLower.includes("tile") && nameLower.includes("tile")) score += 20;
                    if (targetLower.includes("round") && nameLower.includes("round")) score += 20;

                    // D. 門檻篩選
                    // 如果分類不同，文字相似度必須很高才收錄；如果分類相同，門檻可降低
                    if (score > 60) { 
                        candidates.push({ ...data, id, score, category: itemCategory });
                    }
                }
            });

            // 依照分數高低排序，取前 6 名
            candidates.sort((a, b) => b.score - a.score);
            return candidates.slice(0, 6);
        }

        window.getLegoCategory = (id, name) => {
            const n = name ? name.toLowerCase() : "";
            if (n.includes("motor") || n.includes("sensor") || n.includes("hub") || n.includes("battery") || n.includes("electric") || n.includes("light") || n.includes("wire")) return "ELECTRONICS";
            if (n.includes("technic")) {
                if (n.includes("beam") || n.includes("liftarm")) return "TECHNIC-beam";
                if (n.includes("gear") || n.includes("rack") || n.includes("differential") || n.includes("clutch")) return "TECHNIC-gear";
                if (n.includes("pin") || n.includes("connector") || n.includes("bush")) return "TECHNIC-pin";
                if (n.includes("axle")) return "TECHNIC-axle";
                if (n.includes("shock") || n.includes("suspension")) return "TECHNIC-steering";
                if (n.includes("panel")) return "TECHNIC-panel";
                return "TECHNIC";
            }
            if (n.includes("minifigure") || n.includes("minifig") || n.includes("torso") || n.includes("legs") || n.includes("hair") || n.includes("head") || n.includes("helmet")) return "MINIFIG";
            if (n.includes("sword") || n.includes("shield") || n.includes("weapon") || n.includes("utensil") || n.includes("tool") || n.includes("food")) return "MINIFIG-accessory";
            if (n.includes("plant") || n.includes("flower") || n.includes("leaf") || n.includes("tree") || n.includes("grass") || n.includes("stem") || n.includes("limb")) return "NATURE-plant";
            if (n.includes("animal") || n.includes("creature") || n.includes("rock") || n.includes("crystal") || n.includes("flame") || n.includes("water") || n.includes("ice")) return "NATURE-element";
            if (n.includes("wheel") || n.includes("tire") || n.includes("tyre") || n.includes("rim")) return "VEHICLE-wheel";
            if (n.includes("windscreen") || n.includes("windshield") || n.includes("cockpit") || n.includes("chassis") || n.includes("mudguard")) return "VEHICLE-body";
            if (n.includes("propeller") || n.includes("rotor")) return "VEHICLE-air";
            if (n.includes("hinge") || n.includes("turntable") || n.includes("joint") || n.includes("socket") || n.includes("ball") && n.includes("joint")) return "ARTICULATION";
            if (n.includes("click") && n.includes("hinge")) return "ARTICULATION";
            if (n.includes("bracket")) return "SNOT-bracket";
            if ((n.includes("brick") || n.includes("plate")) && (n.includes("knob") || n.includes("studs on side") || n.includes("headlight"))) return "SNOT-brick";
            if (n.includes("curved") || n.includes("arch") || n.includes("round brick") || n.includes("round corner") || n.includes("cylinder") || n.includes("cone") || n.includes("dome") || n.includes("dish") || n.includes("macaroni")) return "CURVE";
            if (n.includes("slope") || n.includes("wedge") || n.includes("roof")) return "ANGLE";
            if (n.includes("window") || n.includes("door") || n.includes("frame") || n.includes("pane") || n.includes("glass") || n.includes("shutter")) return "WALL-window";
            if (n.includes("fence") || n.includes("railing") || n.includes("ladder") || n.includes("stairs") || n.includes("panel")) return "WALL-structure";
            if (n.includes("tile")) { if (n.includes("round")) return "BASIC-round tile"; return "BASIC-tile"; }
            if (n.includes("plate")) { if (n.includes("round")) return "BASIC-round plate"; return "BASIC-plate"; }
            if (n.includes("brick")) { if (n.includes("round")) return "BASIC-round brick"; return "BASIC-brick"; }
            if (n.includes("baseplate")) return "BASIC-baseplate";
            const i = id.toString();
            const map = {
                "62113": "WALL-window", "98283": "WALL-structure", "3005": "BASIC-brick", "3004": "BASIC-brick", "3023": "BASIC-plate", "3024": "BASIC-plate"
            };
            if (map[i]) return map[i];
            return "OTHER";
        };

        window.useSuggestedDrawer = (drawerId) => { 
            const dStr = drawerId.toString(); 
            let input = document.getElementById('drawer-input-active');
            const dynamicArea = document.getElementById('dynamic-action-area');
            const isHidden = dynamicArea && dynamicArea.classList.contains('hidden');

            if (!input || isHidden) {
                const inlineContainer = document.getElementById('inline-action-panel');
                const inlineInput = inlineContainer ? inlineContainer.querySelector('#drawer-input-active') : null;
                if (inlineInput) {
                    input = inlineInput;
                } else {
                    showActionPanel('move');
                    input = document.getElementById('drawer-input-active');
                }
            }

            if (input) {
                const checkbox = input.parentElement.parentElement.querySelector('input[type="checkbox"]'); 
                input.value = dStr.replace('a',''); 
                if(checkbox) checkbox.checked = dStr.includes('a'); 
                input.scrollIntoView({behavior: 'smooth', block: 'center'}); 
                input.classList.add('ring-4', 'ring-purple-300');
                setTimeout(() => input.classList.remove('ring-4', 'ring-purple-300'), 500);
            }
        };

        window.showActionPanel = (action) => { const container = document.getElementById('dynamic-action-area'); container.classList.remove('hidden'); document.getElementById('exist-actions').classList.add('hidden'); setupActionPanel(action, container); document.getElementById('drawer-input-active').value = getNextEmptyDrawerId(); };
        
        function setupActionPanel(action, container) { 
            currentAction = action; 
            container.innerHTML = document.getElementById('action-panel-template').innerHTML; 
            const btn = container.querySelector('#confirm-btn'); 
            const label = container.querySelector('#action-label'); 
            if (action === 'add') { 
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white'); 
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> 確認加入'; 
                label.textContent = "加入位置："; 
            } else { 
                btn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white'); 
                btn.innerHTML = '<i class="fa-solid fa-arrow-right-arrow-left mr-2"></i> 確認移動 (覆蓋)'; 
                label.textContent = "移動至："; 
            } 
            const input = container.querySelector('#drawer-input'); 
            input.id = 'drawer-input-active'; 
            input.onclick = () => { input.value = ""; openKeypad('drawer-input-active'); };
            container.querySelector('#confirm-btn').onclick = executeAction; 
        }

        window.adjustDrawer = (delta) => { const input = document.getElementById('drawer-input-active'); if(input) { let val = parseInt(input.value)||1; val+=delta; if(val<1)val=1; if(val>9999)val=9999; input.value=val; } };
        window.executeAction = async () => { if(!currentPartId) return; const num = document.getElementById('drawer-input-active').value; const activeContainer = document.getElementById('drawer-input-active').closest('#inline-action-panel') || document.getElementById('dynamic-action-area'); const isSub = activeContainer.querySelector('input[type="checkbox"]').checked; const targetDrawer = isSub ? `${num}a` : `${num}`; const btn = activeContainer.querySelector('#confirm-btn'); const originalHtml = btn.innerHTML; const originalClass = btn.className; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; try { if (currentAction === 'move') { if(confirm(`確定移動？\n舊位置將被移除。`)) await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'move'); else { btn.innerHTML = originalHtml; btn.disabled = false; return; } } else { await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'append'); } btn.className = "w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-green-500 transition-all"; btn.innerHTML = '<i class="fa-solid fa-check"></i> 成功'; setTimeout(() => { btn.className = originalClass; btn.innerHTML = originalHtml; btn.disabled = false; if(!document.getElementById('status-exist').classList.contains('hidden')) { document.getElementById('exist-actions').classList.remove('hidden'); document.getElementById('dynamic-action-area').classList.add('hidden'); } }, 1500); } catch(e) { btn.innerHTML = originalHtml; btn.disabled = false; } };
        window.removeLoc = (drawerId) => { if(confirm(`確定移除？`)) window.removeMappingCloud(currentPartId, drawerId); };
        
        window.retryWithGemini = async () => { if(!currentResizedBlob || !geminiApiKey) { alert("無圖片或未設定 Key"); return; } document.getElementById('loading').classList.remove('hidden'); document.getElementById('loading-text').innerText = "Gemini 重試中..."; document.getElementById('result-area').classList.add('hidden'); try { const result = await tryGemini(currentResizedBlob); currentPartName = result.name; currentPartImgUrl = ""; document.getElementById('part-id-input').value = result.id; document.getElementById('res-source').textContent = "Gemini (Retry)"; document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-purple-600 text-white font-bold"; checkAndDisplayDrawer(result.id); } catch(e) { alert(e.message); } finally { document.getElementById('loading').classList.add('hidden'); } };
        
        function resizeImage(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = (event) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width, height = img.height; if (width > 800) { height = Math.round(height * 800 / width); width = 800; } canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); canvas.toBlob(resolve, 'image/jpeg', 0.85); }; img.src = event.target.result; }; reader.readAsDataURL(file); }); }
        
        async function tryBrickognize(blob) { 
            const fd = new FormData(); 
            fd.append('query_image', blob); 
            try {
                const res = await fetch('https://api.brickognize.com/predict/', {method:'POST', body:fd}); 
                if(res.ok) { 
                    const data = await res.json(); 
                    if(data.items?.length > 0) return { id: data.items[0].id, name: data.items[0].name, img: data.items[0].img_url || data.items[0].thumbnail_url, source: 'Brickognize' }; 
                } 
            } catch(e) { console.error("Brickognize Error", e); }
            return null; 
        }

        async function tryGemini(blob) { 
            const b64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); }); 
            const prompt = `Identify this Lego part. Return JSON: { "id": "PART_ID", "name": "Part Name" }. IMPORTANT: ALWAYS Append common Traditional Chinese keywords for this part (e.g., "Brick 2x4 基礎磚", "Technic Beam 科技臂", "Gear 齒輪").`; 
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:prompt}, {inline_data:{mime_type:"image/jpeg", data:b64}}]}], generationConfig:{responseMimeType:"application/json"} }) }); 
            if(!res.ok) throw new Error("API Error"); 
            const json = await res.json(); 
            const data = JSON.parse(json.candidates[0].content.parts[0].text); 
            return { id: data.id, name: data.name, img: "", source: 'Gemini' }; 
        }

        window.toggleSettings = () => { const m = document.getElementById('settings-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) { document.getElementById('gemini-key').value = geminiApiKey; document.getElementById('gemini-model').value = geminiModel; if(geminiApiKey) document.getElementById('key-saved-msg').classList.remove('hidden'); else document.getElementById('key-saved-msg').classList.add('hidden'); } };
        window.saveSettings = () => { geminiApiKey = document.getElementById('gemini-key').value.trim(); geminiModel = document.getElementById('gemini-model').value; localStorage.setItem('lego_gemini_key', geminiApiKey); localStorage.setItem('lego_gemini_model', geminiModel); toggleSettings(); alert("設定已儲存"); };
        
        window.openDrawerContent = (drawerId) => {
            const modal = document.getElementById('drawer-modal');
            const title = document.getElementById('drawer-modal-title');
            const content = document.getElementById('drawer-modal-content');
            
            const dStr = drawerId.toString();
            currentViewingDrawer = dStr;

            keypadInputValue = dStr;
            const jumpInput = document.getElementById('global-jump-input');
            if(jumpInput) jumpInput.value = dStr;
            if(title) {
                title.innerText = dStr;
                title.classList.remove('animate-pulse');
            }

            const partsInDrawer = [];
            Object.entries(window.mappings).forEach(([pid, data]) => {
                if (data.drawers && (data.drawers.includes(dStr) || data.drawers.includes(dStr+'a') || data.drawers.includes(dStr.replace('a','')))) {
                    if(data.drawers.includes(dStr)) partsInDrawer.push({ id: pid, ...data });
                }
            });

            if (partsInDrawer.length === 0) {
                content.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-8">此位置是空的</div>';
            } else {
                content.innerHTML = partsInDrawer.map(p => `
                    <div class="flex flex-col items-center p-2 border rounded-lg hover:bg-blue-50 cursor-pointer transition bg-white relative" onclick="selectPartFromDrawer('${p.id}')">
                        ${p.img ? `<img src="${p.img}" class="w-16 h-16 object-contain mb-2">` : `<div class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center mb-2"><i class="fa-solid fa-cube text-gray-300 text-2xl"></i></div>`}
                        <span class="font-bold text-xs text-blue-600 font-mono break-all text-center">${p.id}</span>
                        <span class="text-[10px] text-gray-500 truncate w-full text-center mt-1">${p.name}</span>
                    </div>
                `).join('');
            }
            modal.classList.remove('hidden');
        };

        window.navDrawer = (delta) => {
            let num = parseInt(currentViewingDrawer.replace('a', '')) || 1;
            num += delta;
            if (num < 1) num = 1;
            openDrawerContent(num.toString());
        };

        window.closeDrawerModal = () => { document.getElementById('drawer-modal').classList.add('hidden'); };
        
        window.selectPartFromDrawer = (partId) => { 
            closeDrawerModal(); 
            currentPartImgUrl = ""; 
            currentPartName = ""; 
            currentResizedBlob = null; 
            const retryBtn = document.getElementById('retry-btn');
            if(retryBtn) retryBtn.classList.add('hidden');
            const srcBadge = document.getElementById('res-source');
            if(srcBadge) {
                srcBadge.textContent = "INVENTORY";
                srcBadge.className = "text-[10px] px-2 py-0.5 rounded bg-blue-500 text-white font-bold";
            }
            setTimeout(() => {
                checkAndDisplayDrawer(partId); 
            }, 100);
        };

        // Rank System
        window.openRankModal = (rank) => {
            currentNavRank = parseInt(rank) || 1;
            updateRankModalUI();
            document.getElementById('rank-nav-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('rank-jump-input').focus(), 100);
        };

        window.closeRankModal = () => {
            document.getElementById('rank-nav-modal').classList.add('hidden');
        };

        window.navRank = (delta) => {
            const nextRank = currentNavRank + delta;
            if (window.rankToPartMap[nextRank]) {
                currentNavRank = nextRank;
                const targetPartId = window.rankToPartMap[currentNavRank];
                checkAndDisplayDrawer(targetPartId);
                updateRankModalUI();
            } else {
                const btn = delta > 0 ? document.querySelector('button[onclick="navRank(1)"]') : document.querySelector('button[onclick="navRank(-1)"]');
                if(btn) {
                    btn.classList.add('shake');
                    setTimeout(() => btn.classList.remove('shake'), 300);
                }
            }
        };

        window.jumpToRank = () => {
            const val = parseInt(document.getElementById('rank-jump-input').value);
            if (!val) return;

            if (window.rankToPartMap[val]) {
                currentNavRank = val;
                const targetPartId = window.rankToPartMap[currentNavRank];
                closeRankModal();
                if (typeof closeKeypad === 'function') closeKeypad();
                checkAndDisplayDrawer(targetPartId);
                updateRankModalUI();
                document.getElementById('rank-jump-input').value = ''; 
            } else {
                alert("找不到該名次的零件 (僅收錄 Top 360)");
                document.getElementById('rank-jump-input').value = ''; 
            }
        };

        function getRankImage(partId) {
            const localData = (window.mappings || {})[partId];
            if (localData && localData.img) {
                return localData.img;
            }
            return `https://cdn.rebrickable.com/media/parts/ldraw/0/${partId}.png`;
        }

        function updateRankModalUI() {
            const rank = currentNavRank;
            const partId = window.rankToPartMap[rank];
            
            document.getElementById('rank-modal-current').innerText = rank;
            const idDisplay = document.getElementById('rank-modal-part-id'); 
            const imgEl = document.getElementById('rank-modal-img');
            
            if (partId) {
                if(idDisplay) {
                    idDisplay.innerText = partId;
                    idDisplay.className = "font-mono font-bold text-lg text-blue-600";
                }
                imgEl.src = getRankImage(partId);
                imgEl.style.opacity = "1";
            } else {
                if(idDisplay) {
                    idDisplay.innerText = "---";
                    idDisplay.className = "font-mono font-bold text-lg text-gray-300";
                }
                imgEl.src = "";
                imgEl.style.opacity = "0";
            }

            const drawerContainer = document.getElementById('rank-modal-drawers');
            drawerContainer.innerHTML = ''; 

            const localData = partId ? (window.mappings || {})[partId] : null;

            if (localData && localData.drawers && localData.drawers.length > 0) {
                localData.drawers.forEach(d => {
                    const dStr = d.toString();
                    const num = parseInt(dStr.replace('a', ''));
                    const isBag = num >= 478;
                    const bgClass = isBag ? "bg-purple-100 text-purple-700 border-purple-200" : "bg-green-100 text-green-700 border-green-200";
                    const icon = isBag ? '<i class="fa-solid fa-bag-shopping mr-1"></i>' : '<i class="fa-solid fa-box-open mr-1"></i>';
                    const btn = document.createElement('button');
                    btn.className = `${bgClass} border px-2 py-1 rounded text-xs font-bold shadow-sm hover:scale-105 active:scale-95 transition flex items-center whitespace-nowrap`;
                    btn.innerHTML = `${icon}${num}`;
                    btn.onclick = () => {
                        closeRankModal(); 
                        if(typeof closeKeypad === 'function') closeKeypad(); 
                        openDrawerContent(num.toString());
                    };
                    drawerContainer.appendChild(btn);
                });
            } else {
                drawerContainer.innerHTML = '<span class="text-[10px] text-gray-300 font-bold border border-dashed border-gray-300 px-2 py-1 rounded">未擁有</span>';
            }
        }

        // [NEW] 重置相機介面
        window.resetPreview = () => {
            document.getElementById('preview-img').src = "";
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('retake-hint').classList.add('hidden');
            document.getElementById('cam-buttons').classList.remove('hidden'); // 確保按鈕重新出現
        };
    </script>
</body>
</html>
