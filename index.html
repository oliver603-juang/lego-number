<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨‚é«˜æŠ½å±œç®¡å®¶ (å®Œç¾ä¿®å¾©ç‰ˆ)</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const fallbackConfig = {
          apiKey: "AIzaSyAXwfm45p417iStJ556rYxR-qsty6dSaXc",
          authDomain: "lego-number.firebaseapp.com",
          projectId: "lego-number",
          storageBucket: "lego-number.firebasestorage.app",
          messagingSenderId: "1041577725604",
          appId: "1:1041577725604:web:b46696cd0933d1a3602031",
          measurementId: "G-25BT9NGHW1"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackConfig;
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Init Error", e); }

        window.mappings = {}; 
        window.inventoryIndex = []; 

        // --- æ“´å……ç‰ˆå¸¸ç”¨é›¶ä»¶å­—å…¸ ---
        window.catalogIndex = [
            {id: "3001", name: "Brick 2 x 4"}, {id: "3002", name: "Brick 2 x 3"}, {id: "3003", name: "Brick 2 x 2"}, 
            {id: "3004", name: "Brick 1 x 2"}, {id: "3005", name: "Brick 1 x 1"}, {id: "3008", name: "Brick 1 x 8"}, 
            {id: "3009", name: "Brick 1 x 6"}, {id: "3010", name: "Brick 1 x 4"}, {id: "3007", name: "Brick 2 x 8"},
            {id: "2453", name: "Brick 1 x 1 x 5"}, {id: "2454", name: "Brick 1 x 2 x 5"},
            {id: "3020", name: "Plate 2 x 4"}, {id: "3021", name: "Plate 2 x 3"}, {id: "3022", name: "Plate 2 x 2"}, 
            {id: "3023", name: "Plate 1 x 2"}, {id: "3024", name: "Plate 1 x 1"}, {id: "3623", name: "Plate 1 x 3"}, 
            {id: "3710", name: "Plate 1 x 4"}, {id: "3666", name: "Plate 1 x 6"}, {id: "3460", name: "Plate 1 x 8"},
            {id: "3032", name: "Plate 4 x 6"}, {id: "3034", name: "Plate 2 x 8"}, {id: "3031", name: "Plate 4 x 4"},
            {id: "3035", name: "Plate 4 x 8"}, {id: "3030", name: "Plate 4 x 10"},
            {id: "3068b", name: "Tile 2 x 2 with Groove"}, {id: "3069b", name: "Tile 1 x 2 with Groove"}, 
            {id: "3070b", name: "Tile 1 x 1 with Groove"}, {id: "6636", name: "Tile 1 x 6"}, {id: "2431", name: "Tile 1 x 4"},
            {id: "4150", name: "Tile, Round 2 x 2"}, {id: "98138", name: "Tile, Round 1 x 1"}, {id: "14769", name: "Tile, Round 2 x 2 with Bottom Stud Holder"},
            {id: "87079", name: "Tile 2 x 4"}, {id: "63864", name: "Tile 1 x 3"},
            {id: "2412b", name: "Tile, Modified 1 x 2 Grille (Radiator)"}, 
            {id: "3039", name: "Slope 45 2 x 2"}, {id: "3040", name: "Slope 45 2 x 1"}, {id: "3298", name: "Slope 33 3 x 2"},
            {id: "85984", name: "Slope 30 1 x 2 x 2/3"}, {id: "54200", name: "Slope 30 1 x 1 x 2/3 (Cheese Slope)"},
            {id: "3660", name: "Slope, Inverted 45 2 x 2"}, {id: "3665", name: "Slope, Inverted 45 2 x 1"},
            {id: "11477", name: "Slope, Curved 2 x 1 No Studs"}, {id: "15068", name: "Slope, Curved 2 x 2 x 2/3"},
            {id: "87087", name: "Brick, Modified 1 x 1 with Stud on 1 Side"}, {id: "4070", name: "Brick, Modified 1 x 1 with Headlight"},
            {id: "4733", name: "Brick, Modified 1 x 1 with Studs on 4 Sides"}, {id: "2420", name: "Plate, Corner 2 x 2"}, 
            {id: "15573", name: "Plate, Modified 1 x 2 with 1 Stud (Jumper)"}, {id: "3794b", name: "Plate, Modified 1 x 2 with 1 Stud (Jumper)"},
            {id: "87580", name: "Plate, Modified 2 x 2 with Groove and 1 Stud in Center (Jumper)"}, {id: "11458", name: "Plate, Modified 1 x 2 with Pin Hole on Top"},
            {id: "3700", name: "Technic, Brick 1 x 2 with Hole"}, {id: "3894", name: "Technic, Brick 1 x 6 with Holes"}, 
            {id: "32062", name: "Technic, Axle 2 Notched"}, {id: "4519", name: "Technic, Axle 3"},
            {id: "3705", name: "Technic, Axle 4"}, {id: "3706", name: "Technic, Axle 6"}, 
            {id: "32523", name: "Technic, Liftarm Thick 1 x 3"}, {id: "32524", name: "Technic, Liftarm Thick 1 x 7"}, 
            {id: "32278", name: "Technic, Liftarm Thick 1 x 15"}, {id: "2780", name: "Technic, Pin with Friction Ridges"}, 
            {id: "3673", name: "Technic, Pin without Friction Ridges"}, {id: "43093", name: "Technic, Axle Pin with Friction Ridges"},
            {id: "24299", name: "Wedge, Plate 2 x 2 Left"}, {id: "24307", name: "Wedge, Plate 2 x 2 Right"},
            {id: "54383", name: "Wedge, Plate 3 x 6 Cut Corners"}, {id: "54384", name: "Wedge, Plate 6 x 3 Left"},
            {id: "2555", name: "Tile, Modified 1 x 1 with Clip"}, {id: "4085d", name: "Plate, Modified 1 x 1 with Clip Vertical"},
            {id: "4081b", name: "Plate, Modified 1 x 1 with Clip Light"}, {id: "61252", name: "Plate, Modified 1 x 1 with Clip Horizontal"},
            {id: "53451", name: "Barb / Claw / Horn - Small"} 
        ].map(i => ({...i, searchStr: `${i.id} ${i.name}`.toLowerCase()}));

        async function initApp() {
            if (!auth) return;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('cloud-status').innerHTML = '<i class="fa-solid fa-cloud text-green-500"></i>';
                    startSync(user);
                } else {
                    signInAnonymously(auth);
                }
            });
        }

        function startSync(user) {
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            onSnapshot(collRef, (snapshot) => {
                const newMappings = {};
                const newIndex = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let drawers = [];
                    if (Array.isArray(data.drawers)) drawers = data.drawers;
                    else if (data.drawer_id) drawers = [data.drawer_id];
                    
                    const partData = {
                        drawers: drawers,
                        name: data.part_name || "",
                        img: data.img_url || "" 
                    };

                    if (drawers.length > 0) {
                        newMappings[doc.id] = partData;
                        newIndex.push({
                            id: doc.id,
                            name: partData.name,
                            img: partData.img,
                            drawers: drawers,
                            type: 'inventory',
                            searchStr: `${doc.id} ${partData.name}`.toLowerCase()
                        });
                    }
                });
                window.mappings = newMappings;
                window.inventoryIndex = newIndex;

                if (currentPartId) checkAndDisplayDrawer(currentPartId);
            });
        }

        // --- Database Actions ---
        window.saveMappingCloud = async (partId, drawerId, partName, imgUrl, mode = 'append') => {
            if (!db) return;
            const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
            try {
                const docSnap = await getDoc(docRef);
                if (mode === 'move') { 
                    const oldData = docSnap.exists() ? docSnap.data() : {};
                    await (docSnap.exists() ? updateDoc : setDoc)(docRef, {
                        part_id: partId,
                        drawers: [drawerId], 
                        part_name: partName || oldData.part_name || "",
                        img_url: imgUrl ? imgUrl : (oldData.img_url || ""),
                        updated_at: new Date().toISOString()
                    });
                } else { 
                    if (docSnap.exists()) {
                        await updateDoc(docRef, {
                            drawers: arrayUnion(drawerId),
                            part_name: partName || docSnap.data().part_name,
                            img_url: imgUrl ? imgUrl : docSnap.data().img_url,
                            updated_at: new Date().toISOString()
                        });
                    } else {
                        await setDoc(docRef, {
                            part_id: partId,
                            drawers: [drawerId],
                            part_name: partName,
                            img_url: imgUrl || "",
                            updated_at: new Date().toISOString()
                        });
                    }
                }
            } catch (e) {
                alert("å„²å­˜å¤±æ•—: " + e.message);
                throw e;
            }
        };

        window.removeMappingCloud = async (partId, drawerIdToRemove) => {
            if (!db) return;
            try {
                const docRef = doc(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings', partId);
                await updateDoc(docRef, { drawers: arrayRemove(drawerIdToRemove) });
            } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
        };

        window.clearAllCloudData = async () => {
            if (!db || !confirm("ã€åš´é‡è­¦å‘Šã€‘ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ") || !confirm("å†æ¬¡ç¢ºèªï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) return;
            const collRef = collection(db, 'artifacts', 'lego-number-app', 'public', 'data', 'lego_mappings');
            const snapshot = await getDocs(collRef);
            const batchSize = 500;
            let batch = writeBatch(db);
            let count = 0;
            for (const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= batchSize) { await batch.commit(); batch = writeBatch(db); count = 0; }
            }
            if (count > 0) await batch.commit();
            alert("å·²æ¸…ç©ºè³‡æ–™åº«");
            toggleSettings();
        };

// ==========================================
//   KEYPAD SYSTEM (å°ç®—ç›¤æ ¸å¿ƒæ¨¡çµ„ - å®Œæ•´ç‰ˆ)
// ==========================================

// 1. é—œé–‰éµç›¤ (é€™æ˜¯åŸæœ¬éºå¤±çš„é—œéµå‡½å¼)
window.closeKeypad = () => {
    const modal = document.getElementById('keypad-modal');
    const content = document.getElementById('keypad-content');
    
    // å…ˆåŸ·è¡Œæ»‘å‡ºçš„å‹•ç•« (åŠ ä¸Š translate-y-full)
    content.classList.add('translate-y-full');
    
    // ç§»é™¤ä¸»ç•«é¢çš„åº•éƒ¨ç•™ç™½ (æ¢å¾©åŸç‹€)
    document.getElementById('main-content').classList.remove('pb-keypad');

    // ç­‰å‹•ç•«çµæŸå¾Œ (300ms)ï¼Œå†éš±è—æ•´å€‹é®ç½©
    setTimeout(() => {
        modal.classList.add('hidden');
        currentKeypadTarget = null; // æ¸…ç©ºç›®æ¨™ç‹€æ…‹
    }, 300);
};

// 2. é–‹å•Ÿè·³è½‰å°ˆç”¨éµç›¤ (æ”¯æ´äºŒæ¬¡é»æ“Šé—œé–‰)
window.openDrawerJumpKeypad = () => {
    const modal = document.getElementById('keypad-modal');
    
    // é‚è¼¯åˆ¤æ–·ï¼šå¦‚æœéµç›¤å·²ç¶“æ‰“é–‹ï¼Œä¸”ç›®æ¨™æ˜¯è·³è½‰è¼¸å…¥æ¡†ï¼Œå‰‡åŸ·è¡Œé—œé–‰ (Toggleæ•ˆæœ)
    if (!modal.classList.contains('hidden') && currentKeypadTarget === 'global-jump-input') {
        closeKeypad();
        return;
    }

    const inp = document.getElementById('global-jump-input');
    inp.value = ""; // æ¸…ç©ºèˆŠå€¼ï¼Œæº–å‚™è¼¸å…¥æ–°è™Ÿç¢¼
    openKeypad('global-jump-input');
};

// 3. é€šç”¨é–‹å•Ÿéµç›¤å‡½å¼
window.openKeypad = (id) => { 
    currentKeypadTarget = id; 
    const modal = document.getElementById('keypad-modal'); 
    const content = document.getElementById('keypad-content'); 
    
    // A. é è¦½æ–‡å­—åŒæ­¥
    const preview = document.getElementById('keypad-preview');
    const targetInput = document.getElementById(id);
    if(preview && targetInput) preview.innerText = targetInput.value;

    // B. é¡¯ç¤ºè¦–çª—èˆ‡å‹•ç•«
    modal.classList.remove('hidden'); 
    // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ remove class åœ¨ä¸‹ä¸€å¹€åŸ·è¡Œï¼Œè§¸ç™¼ CSS transition å‹•ç•«
    requestAnimationFrame(() => {
        content.classList.remove('translate-y-full');
    });
    
    // C. ç•«é¢æ²å‹•è™•ç† (UX å„ªåŒ–)
    // å¦‚æœä¸æ˜¯éš±è—çš„è·³è½‰è¼¸å…¥æ¡†ï¼Œæ‰éœ€è¦æŠŠç•«é¢å¾€ä¸Šæ¨ï¼Œé¿å…æ“‹ä½è¼¸å…¥æ¡†
    if(id !== 'global-jump-input') {
        document.getElementById('main-content').classList.add('pb-keypad'); 
        // å»¶é²ä¸€é»é»æ²å‹•ï¼Œé«”é©—è¼ƒé †æš¢
        setTimeout(() => {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
        }, 300); 
    }
};

// 4. æŒ‰éµè¼¸å…¥è™•ç† (k å‡½å¼)
window.k = (key) => { 
    // é˜²å‘†ï¼šå¦‚æœæ²’æœ‰ç›®æ¨™è¼¸å…¥æ¡†ï¼Œä¸åŸ·è¡Œ
    if(!currentKeypadTarget) return;

    const inp = document.getElementById(currentKeypadTarget); 
    if(!inp) return; 
    
    let newVal = inp.value;

    // è™•ç†ç‰¹æ®Šéµ
    if(key === 'del') {
        newVal = newVal.slice(0, -1); 
    } else if(key === 'clr') {
        newVal = ''; 
    } else if(key === 'ok') { 
        confirmKeypad(); 
        return; 
    } else {
        // è™•ç†æ•¸å­—éµ (é™åˆ¶æœ€å¤§é•·åº¦ï¼Œé¿å…ç„¡é™è¼¸å…¥)
        if(newVal.length < 5) {
            newVal += key;
        }
    }
    
    // æ›´æ–°è¼¸å…¥æ¡†èˆ‡é è¦½
    inp.value = newVal;
    const preview = document.getElementById('keypad-preview');
    if(preview) preview.innerText = newVal;
};

// 5. ç¢ºèªæŒ‰éµé‚è¼¯
window.confirmKeypad = () => {
     const inp = document.getElementById(currentKeypadTarget);
     
     if(inp) {
         let val = inp.value;
         
         // é‚è¼¯ A: é¦–é æˆ–æŠ½å±œå…§çš„ã€Œè·³è½‰ã€åŠŸèƒ½
         if (currentKeypadTarget === 'global-jump-input') {
             if (val === "") val = "1"; // é˜²å‘†ï¼šç©ºå€¼é è¨­ç‚º 1
             openDrawerContent(val);
         }
         // é‚è¼¯ B: æ–°å¢æˆ–ç§»å‹•ä½ç½®æ™‚çš„è¼¸å…¥ (åƒ…éœ€æ”¶èµ·éµç›¤ï¼Œå€¼å·²åœ¨ input ä¸­)
         else if (currentKeypadTarget === 'drawer-input' || currentKeypadTarget === 'drawer-input-active') {
             // å¯ä»¥åœ¨é€™è£¡åŠ å…¥é¡å¤–çš„é©—è­‰é‚è¼¯ï¼Œç›®å‰ä¿æŒåŸæ¨£
         }
     }
     // æŒ‰ä¸‹ OK å¾Œï¼Œçµ±ä¸€é—œé–‰éµç›¤
     closeKeypad();
};

        initApp();
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pb-keypad { padding-bottom: 400px !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .suggestion-item.active { background-color: #ebf8ff; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-cubes mr-2"></i>æ¨‚é«˜ç®¡å®¶</h1>
            <div class="flex items-center space-x-4">
                <div id="cloud-status" class="text-xs">...</div>
                <button onclick="toggleSettings()" class="hover:text-blue-200"><i class="fa-solid fa-gear text-xl"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow p-4 max-w-md mx-auto w-full pb-24 transition-all relative">
        
        <!-- 1. çµ±ä¸€æœå°‹å€ -->
        <div class="bg-white p-6 rounded-xl shadow-lg text-center mb-6 relative z-30">
            <!-- Action Click to Start Live Camera -->
            <div class="mb-4 relative group cursor-pointer" onclick="startCamera()">
                <div id="preview-container" class="w-full h-40 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden relative transition hover:border-blue-400 hover:bg-blue-50">
                    <div class="text-gray-400 flex flex-col items-center">
                        <i class="fa-solid fa-camera text-4xl mb-2"></i>
                        <span class="text-sm font-bold">é»æ“Šé–‹å•Ÿç›¸æ©Ÿ</span>
                    </div>
                    <!-- Captured Image Preview -->
                    <img id="preview-img" class="absolute inset-0 w-full h-full object-contain hidden" />
                </div>
            </div>
            <!-- Backup Input for file upload -->
            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleImageFile(this.files[0])">

            <div id="loading" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-2"></div>
                <span id="loading-text" class="text-xs text-gray-500">è™•ç†ä¸­...</span>
            </div>

            <!-- Manual Input -->
            <div class="relative">
    <div class="flex items-center border-b-2 border-gray-200 focus-within:border-blue-500 py-2 px-2 mt-2">
        <i class="fa-solid fa-keyboard text-gray-400 mr-3"></i>
        <input type="text" id="part-id-input" class="flex-1 bg-transparent outline-none font-mono font-bold text-lg text-gray-700 placeholder-gray-300" placeholder="è¼¸å…¥ ID æˆ–é—œéµå­—..." oninput="handleInputSearch(this.value)" onkeydown="handleSearchKeydown(event)" autocomplete="off">
        
        <button id="retry-btn" onclick="retryWithGemini()" class="hidden text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full ml-2 font-bold flex items-center">
            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Gemini
        </button>

        <button onclick="openDrawerJumpKeypad()" class="ml-2 w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition active:scale-95">
            <i class="fa-solid fa-calculator text-lg"></i>
        </button>
    </div>
    <div id="search-suggestions" class="absolute top-full left-0 right-0 bg-white shadow-xl rounded-b-xl border border-t-0 border-gray-200 max-h-72 overflow-y-auto hidden z-40"></div>
</div>

<input type="hidden" id="global-jump-input">
        </div>

        <!-- 2. çµæœèˆ‡æ“ä½œå€ -->
        <div id="result-area" class="hidden space-y-4">
            <!-- è³‡è¨Šå¡ -->
            <div class="bg-white p-4 rounded-xl shadow-lg border-l-4" id="info-card">
    <div class="flex items-start mb-4">
        <img id="api-img" src="" class="w-20 h-20 object-contain bg-gray-50 rounded border border-gray-200 mr-4 hidden">
        <div class="flex-1 min-w-0">
            <div class="flex justify-between items-start">
                <h2 class="text-3xl font-black font-mono text-gray-800 leading-none" id="res-part-id">---</h2>
                <span id="res-source" class="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-500 font-bold">SRC</span>
            </div>
            <p class="text-sm text-gray-500 mt-1 leading-tight break-words" id="res-part-name">---</p>
        </div>
    </div>

    <div id="status-exist" class="hidden">
        <div class="mb-4">
            <p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">Current Location</p>
            <div id="drawer-list" class="flex flex-wrap gap-2"></div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-4" id="exist-actions">
            <button onclick="showActionPanel('add')" class="bg-blue-50 border border-blue-200 text-blue-700 py-3 rounded-lg font-bold text-sm hover:bg-blue-100 flex justify-center items-center"><i class="fa-solid fa-plus-circle mr-2 text-lg"></i> æ–°å¢ä½ç½®</button>
            <button onclick="showActionPanel('move')" class="bg-red-50 border border-red-200 text-red-700 py-3 rounded-lg font-bold text-sm hover:bg-red-100 flex justify-center items-center"><i class="fa-solid fa-arrow-right-arrow-left mr-2 text-lg"></i> ç§»å‹•ä½ç½®</button>
        </div>
    </div>

    <div id="status-new" class="hidden">
        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-3"><p class="text-yellow-800 font-bold text-sm flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> å°šæœªç™»éŒ„ï¼Œè¨­å®šæ–°ä½ç½®ï¼š</p></div>
        <div id="inline-action-panel"></div> 
    </div>

    <div id="dynamic-action-area" class="mt-4 hidden border-t border-gray-100 pt-4"></div>

    <div id="universal-suggestions" class="mt-6 pt-4 border-t-2 border-dashed border-gray-200 hidden">
        <p class="text-xs font-bold text-gray-500 mb-3 flex items-center">
            <i class="fa-solid fa-wand-magic-sparkles mr-1 text-purple-500"></i> 
            ç›¸ä¼¼é›¶ä»¶èˆ‡å»ºè­°ä½ç½® (é»æ“Šå¥—ç”¨)ï¼š
        </p>
        <div id="universal-similar-list" class="space-y-2"></div>
    </div>
</div>
            <!-- æ“ä½œé¢æ¿æ¨¡æ¿ -->
            <div id="action-panel-template" class="hidden">
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-gray-700" id="action-label">ç›®æ¨™æŠ½å±œï¼š</span>
                        <div class="flex items-center gap-2">
                             <button onclick="adjustDrawer(-1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-minus"></i></button>
                             <input type="text" id="drawer-input" class="w-24 p-2 border-2 border-blue-500 rounded-lg text-center text-2xl font-black text-blue-700 bg-white cursor-pointer shadow-inner" readonly onclick="openKeypad('drawer-input')">
                             <button onclick="adjustDrawer(1)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 mb-1">
                        <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="drawer-sub" class="w-5 h-5 accent-blue-600 rounded"><span class="text-sm font-bold text-gray-500">å¤¾å±¤ a</span></label>
                    </div>
                    <button id="confirm-btn" class="w-full py-3.5 rounded-xl font-bold text-white shadow-md transition-all active:scale-95 text-lg flex justify-center items-center">ç¢ºèª</button>
                </div>
            </div>
        </div>
    </main>

    <!-- NEW: Drawer Content Modal -->
    <div id="drawer-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <!-- Navigation Controls -->
                <div class="flex items-center justify-between w-full">
					<button onclick="navDrawer(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm text-gray-600 hover:text-blue-600 active:scale-95 transition">
						<i class="fa-solid fa-minus"></i>
					</button>
					
					<div onclick="openDrawerJumpKeypad()" class="flex-1 flex flex-col items-center justify-center cursor-pointer group mx-2 py-1 rounded-lg hover:bg-gray-50 transition active:scale-95">
						<span class="text-3xl font-black text-blue-600 font-mono tracking-tight group-hover:text-blue-700" id="drawer-modal-title">---</span>
						<div class="flex items-center gap-1 text-[10px] text-gray-400 font-bold uppercase tracking-widest group-hover:text-blue-400">
							<i class="fa-solid fa-pen"></i> é»æ“Šè·³è½‰
						</div>
					</div>

					<button onclick="navDrawer(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm text-gray-600 hover:text-blue-600 active:scale-95 transition">
						<i class="fa-solid fa-plus"></i>
					</button>
				</div>
            </div>
            <div id="drawer-modal-content" class="p-4 overflow-y-auto grid grid-cols-3 gap-3 bg-gray-50/50">
                <!-- Parts go here -->
            </div>
        </div>
    </div>

    <!-- NEW: Live Camera Overlay -->
    <div id="camera-overlay" class="fixed inset-0 bg-black z-[90] hidden flex flex-col">
        <div class="relative flex-1 bg-black overflow-hidden flex items-center justify-center">
            <video id="camera-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <button onclick="stopCamera()" class="absolute top-4 right-4 text-white w-10 h-10 flex items-center justify-center bg-black/50 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="h-32 bg-black flex items-center justify-center gap-12 pb-6 pt-2">
            <button onclick="document.getElementById('camera-input').click()" class="text-white flex flex-col items-center opacity-80 hover:opacity-100">
                <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center mb-1"><i class="fa-solid fa-image text-lg"></i></div>
                <span class="text-[10px]">ç›¸ç°¿</span>
            </button>
            <button onclick="takePhoto()" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 ring-2 ring-white active:scale-95 transition"></button>
            <div class="w-10"></div>
        </div>
    </div>

<div id="keypad-modal" class="fixed inset-0 z-[100] hidden flex items-end justify-center pointer-events-none">
    <div class="bg-white w-full max-w-md shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl p-5 pointer-events-auto transform transition-transform duration-300 translate-y-full" id="keypad-content">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            
            <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-red-50 hover:text-red-500 transition active:scale-95">
                <i class="fa-solid fa-xmark"></i>
            </button>
            
            <span id="keypad-preview" class="flex-1 text-right text-3xl font-black text-blue-600 font-mono mx-4 min-h-[40px]"></span>

            <button onclick="closeKeypad()" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 active:scale-95">
                <i class="fa-solid fa-chevron-down"></i>
            </button>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <button onclick="k('1')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">1</button>
            <button onclick="k('2')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">2</button>
            <button onclick="k('3')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">3</button>
            
            <button onclick="k('4')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">4</button>
            <button onclick="k('5')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">5</button>
            <button onclick="k('6')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">6</button>
            
            <button onclick="k('7')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">7</button>
            <button onclick="k('8')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">8</button>
            <button onclick="k('9')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">9</button>
            
            <button onclick="k('clr')" class="bg-red-50 border-b-4 border-red-200 rounded-xl p-3 text-red-500 text-lg font-bold active:border-b-0 active:translate-y-1 transition-all">æ¸…ç©º</button>
            
            <button onclick="k('0')" class="bg-gray-50 border-b-4 border-gray-200 rounded-xl p-3 text-2xl font-bold active:border-b-0 active:translate-y-1 active:bg-blue-50 transition-all">0</button>
            <button onclick="k('ok')" class="bg-blue-600 border-b-4 border-blue-800 rounded-xl p-3 text-white text-xl font-bold active:border-b-0 active:translate-y-1 transition-all">OK</button>
        </div>
    </div>
</div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-gray-800">è¨­å®š</h3>
            <div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1">Gemini API Key</label><input type="password" id="gemini-key" class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 outline-none"></div>
            <div class="mb-6"><label class="block text-xs font-bold text-gray-500 mb-1">AI Model</label><select id="gemini-model" class="w-full border-2 border-gray-200 rounded-lg p-2 bg-white"><option value="gemini-1.5-flash">1.5 Flash</option><option value="gemini-1.5-pro">1.5 Pro</option><option value="gemini-2.0-flash-exp">2.0 Flash Exp</option></select></div>
            <hr class="border-gray-100 mb-4"><button onclick="window.clearAllCloudData()" class="w-full text-red-500 border border-red-200 bg-red-50 p-3 rounded-lg mb-4 text-sm font-bold hover:bg-red-100 transition">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
            <div class="flex justify-end gap-3"><button onclick="toggleSettings()" class="px-5 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button><button onclick="saveSettings()" class="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700">å„²å­˜</button></div>
        </div>
    </div>

    <script>
        // State
        let currentPartId = null;
        let currentPartName = "";
        let currentPartImgUrl = "";
        let currentResizedBlob = null;
        let currentKeypadTarget = null;
        let currentAction = 'append'; 
        let videoStream = null; 
        let currentViewingDrawer = null; 
        let keypadInputValue = ""; 
        let currentSuggestions = []; // New: Store suggestions for safe referencing

        let geminiApiKey = localStorage.getItem('lego_gemini_key') || "";
        let geminiModel = localStorage.getItem('lego_gemini_model') || "gemini-1.5-flash";
        let selectedSuggestionIndex = -1;

        if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));

        // --- Camera Logic ---
        window.startCamera = async () => {
            try {
                const constraints = { video: { facingMode: { ideal: "environment" } } };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-video');
                video.srcObject = stream;
                videoStream = stream;
                document.getElementById('camera-overlay').classList.remove('hidden');
                video.play().catch(e => console.log(e));
            } catch (err) {
                console.error(err);
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ä½¿ç”¨ç›¸ç°¿ä¸Šå‚³ã€‚\n" + err.message);
                document.getElementById('camera-input').click();
            }
        };

        window.stopCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('camera-overlay').classList.add('hidden');
        };

        window.takePhoto = () => {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => { stopCamera(); processBlob(blob); }, 'image/jpeg', 0.9);
        };

        window.handleImage = (input) => { if (input.files[0]) handleImageFile(input.files[0]); };
        window.handleImageFile = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            processBlob(file);
        };

        async function processBlob(blob) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('loading-text').innerText = "è™•ç†ä¸­...";

            try {
                const resizedBlob = await resizeImage(blob);
                currentResizedBlob = resizedBlob; 
                if(!document.getElementById('preview-img').src || document.getElementById('preview-img').classList.contains('hidden')) {
                     const url = URL.createObjectURL(resizedBlob);
                     document.getElementById('preview-img').src = url;
                     document.getElementById('preview-img').classList.remove('hidden');
                }
                let result = await tryBrickognize(resizedBlob);
                if (!result) {
                    if (geminiApiKey) {
                        document.getElementById('loading-text').innerText = "Brickognize ç„¡çµæœï¼Œåˆ‡æ›è‡³ Gemini AI...";
                        result = await tryGemini(resizedBlob);
                    } else { throw new Error("Brickognize ç„¡çµæœä¸”æœªè¨­å®š API Key"); }
                }
                currentPartName = result.name;
                currentPartImgUrl = result.img;
                document.getElementById('part-id-input').value = result.id;
                document.getElementById('res-source').textContent = result.source;
                document.getElementById('res-source').className = `text-[10px] px-2 py-0.5 rounded font-bold text-white ${result.source==='Brickognize'?'bg-green-500':'bg-purple-500'}`;

                checkAndDisplayDrawer(result.id);
                document.getElementById('retry-btn').classList.remove('hidden');
            } catch (e) { alert(e.message); } finally { document.getElementById('loading').classList.add('hidden'); }
        }

        // --- Search & Autocomplete Logic (Fix: Fuzzy & Safe Click) ---
        window.handleInputSearch = (value) => {
            selectedSuggestionIndex = -1;
            const suggestionsBox = document.getElementById('search-suggestions');
            if (!value || value.length < 1) { suggestionsBox.classList.add('hidden'); return; }
            
            const cleanValue = value.replace(/[^\w\s\u4e00-\u9fa5]/g, ' ').trim();
            const terms = cleanValue.toLowerCase().split(/\s+/).filter(t => t.length > 0);
            
            const inventoryMatches = window.inventoryIndex.map(item => calculateScore(item, value, terms)).filter(i => i.score > 0);
            const existingIds = new Set(window.inventoryIndex.map(i => i.id));
            const catalogMatches = window.catalogIndex.filter(item => !existingIds.has(item.id)).map(item => calculateScore({...item, type: 'catalog'}, value, terms)).filter(i => i.score > 0);
            const allMatches = [...inventoryMatches, ...catalogMatches];
            allMatches.sort((a, b) => b.score - a.score);
            const topMatches = allMatches.slice(0, 12);
            
            window.currentSuggestions = topMatches; // Store for safe access

            if (topMatches.length > 0) {
                suggestionsBox.innerHTML = topMatches.map((m, index) => {
                    const highlightedName = highlightText(m.name, value);
                    const highlightedId = highlightText(m.id, value);
                    let badgeHtml = m.type === 'inventory' ? `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold ml-2">${parseInt(m.drawers[0].toString().replace('a','')) > 477 ? `ğŸ“¦ å¤¾éˆè¢‹ ${m.drawers[0]}` : `æŠ½å±œ ${m.drawers[0]}`}</span>` : `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded font-bold ml-2"><i class="fa-solid fa-book-open mr-1"></i>å­—å…¸</span>`;
                    // Fix: Use index instead of passing strings to avoid quote issues
                    return `<div id="suggestion-${index}" class="suggestion-item flex items-center p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0 transition-colors" onclick="selectSuggestionByIndex(${index})">${m.img?`<img src="${m.img}" class="w-10 h-10 object-contain mr-3 bg-gray-50 rounded border">`:'<div class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center"><i class="fa-solid fa-cube text-gray-300"></i></div>'}<div class="overflow-hidden flex-1"><div class="font-bold font-mono text-blue-600 flex items-center"><span>${highlightedId}</span>${badgeHtml}</div><div class="text-xs text-gray-500 truncate mt-0.5">${highlightedName}</div></div></div>`;
                }).join('');
                suggestionsBox.classList.remove('hidden');
            } else { suggestionsBox.classList.add('hidden'); }
        };

        function calculateScore(item, value, terms) {
            let score = 0; 
            const idLower = item.id.toLowerCase();
            const rawValueLower = value.toLowerCase();
            if (idLower === rawValueLower) score += 100;
            else if (idLower.startsWith(rawValueLower)) score += 80;
            else if (idLower.includes(rawValueLower)) score += 20;

            // Fuzzy Match Logic
            let matchCount = 0;
            terms.forEach(term => {
                if (item.searchStr.includes(term)) matchCount++;
            });

            if (matchCount > 0) {
                score += 10;
                score += (matchCount / terms.length) * 50; 
                if (item.name.toLowerCase().startsWith(terms[0])) score += 30;
            }

            if (score === 0) return { score: 0 };
            return { ...item, score };
        }

        function highlightText(text, query) {
            if(!query) return text;
            const cleanQuery = query.replace(/[^\w\s\u4e00-\u9fa5]/g, ' ').trim();
            const terms = cleanQuery.split(/\s+/).filter(t => t.length > 0);
            let result = text;
            terms.forEach(term => {
                if(term.length > 0) {
                    const regex = new RegExp(`(${term})`, 'gi');
                    result = result.replace(regex, '<span class="bg-yellow-200 text-gray-900 font-bold">$1</span>');
                }
            });
            return result;
        }

        window.selectSuggestionByIndex = (index) => {
            const m = window.currentSuggestions[index];
            if(m) selectSuggestion(m.id, m.type, m.name);
        };

        window.selectSuggestion = (id, type, name) => { 
            document.getElementById('part-id-input').value = id; 
            document.getElementById('search-suggestions').classList.add('hidden'); 
            if(type === 'catalog') { 
                currentPartName = name; 
                document.getElementById('res-source').textContent = "CATALOG"; 
                document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-gray-500 text-white font-bold"; 
            } 
            manualSearch(); 
        };

        // ... [Keyboard, Settings, Utils same as before] ...
        window.handleSearchKeydown = (e) => { const box = document.getElementById('search-suggestions'); if (box.classList.contains('hidden')) return; const items = box.querySelectorAll('.suggestion-item'); if (items.length === 0) return; if (e.key === 'ArrowDown') { e.preventDefault(); selectedSuggestionIndex++; if (selectedSuggestionIndex >= items.length) selectedSuggestionIndex = 0; updateSelectionStyle(items); items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'}); } else if (e.key === 'ArrowUp') { e.preventDefault(); selectedSuggestionIndex--; if (selectedSuggestionIndex < 0) selectedSuggestionIndex = items.length - 1; updateSelectionStyle(items); items[selectedSuggestionIndex].scrollIntoView({behavior: 'smooth', block: 'nearest'}); } else if (e.key === 'Enter') { e.preventDefault(); if (selectedSuggestionIndex > -1) items[selectedSuggestionIndex].click(); else { manualSearch(); box.classList.add('hidden'); } } else if (e.key === 'Escape') { box.classList.add('hidden'); } };
        function updateSelectionStyle(items) { items.forEach((item, idx) => { if (idx === selectedSuggestionIndex) item.classList.add('active'); else item.classList.remove('active'); }); }
        function getNextEmptyDrawerId() { const used = new Set(); Object.values(window.mappings || {}).forEach(d => { if(d.drawers) d.drawers.forEach(dr => used.add(dr.toString().replace('a',''))); }); for(let i=1; i<=9999; i++) if(!used.has(i.toString())) return i; return 1; }
        function levenshtein(a,b){if(a.length===0)return b.length;if(b.length===0)return a.length;var matrix=[];for(var i=0;i<=b.length;i++)matrix[i]=[i];for(var j=0;j<=a.length;j++)matrix[0][j]=j;for(var i=1;i<=b.length;i++){for(var j=1;j<=a.length;j++){if(b.charAt(i-1)==a.charAt(j-1))matrix[i][j]=matrix[i-1][j-1];else matrix[i][j]=Math.min(matrix[i-1][j-1]+1,Math.min(matrix[i][j-1]+1,matrix[i-1][j]+1))}}return matrix[b.length][a.length]}
        // ä¿®æ­£å¾Œçš„ç›¸ä¼¼é›¶ä»¶æœå°‹å‡½å¼
		function findSimilarParts(targetName) {
			if (!targetName) return [];
			
			const candidates = [];
			const target = targetName.toLowerCase();

			Object.entries(window.mappings).forEach(([id, data]) => {
				// åªæ¯”å°æœ‰åå­—ä¸”æœ‰åº«å­˜ä½ç½®çš„é›¶ä»¶
				if (data.name && data.drawers.length > 0) {
					const nameLower = data.name.toLowerCase();
					
					// æ’é™¤è‡ªå·± (é¿å…æ¨è–¦è‡ªå·±)
					if (nameLower === target) return;

					const dist = levenshtein(target, nameLower);
					
					// å„ªåŒ–ï¼šè¨ˆç®—ç›¸ä¼¼åº¦é–¾å€¼ (ä¾‹å¦‚åå­—å¾ˆçŸ­æ™‚ï¼Œå®¹éŒ¯è¦å°ï¼›åå­—é•·æ™‚ï¼Œå®¹éŒ¯å¯å¤§)
					// é€™è£¡è¨­å®šï¼šåªæœ‰ç•¶ç·¨è¼¯è·é›¢å°æ–¼åå­—é•·åº¦çš„ 80% æ‰è¦–ç‚ºç›¸ä¼¼ï¼Œé¿å…æ¨è–¦å®Œå…¨ä¸ç›¸å¹²çš„æ±è¥¿
					if (dist < Math.max(target.length, nameLower.length) * 0.8) {
						candidates.push({ ...data, id, dist });
					}
				}
			});

			// ä¾ç›¸ä¼¼åº¦æ’åº (è·é›¢è¶Šå°è¶Šç›¸ä¼¼)
			candidates.sort((a, b) => a.dist - b.dist);

			// [é—œéµä¿®æ”¹] æ”¹ç‚ºå›å‚³å‰ 7 ç­† (åŸæœ¬æ˜¯ 3)
			return candidates.slice(0, 7);
		}
        // ä¿®æ”¹å¾Œçš„é¡¯ç¤ºå‡½å¼ï¼šçµ±ä¸€è™•ç†ç›¸ä¼¼æ¨è–¦
// ä¿®æ”¹å¾Œçš„é¡¯ç¤ºå‡½å¼ï¼šå¢åŠ ã€Œè‡ªå‹•æŸ¥æ‰¾åç¨±ã€ä»¥è§¸ç™¼ç›¸ä¼¼æ¨è–¦
function checkAndDisplayDrawer(partId) {
    currentPartId = partId;
    const partData = (window.mappings || {})[partId];
    const drawers = partData ? partData.drawers : [];
    
    // --- [NEW] é—œéµä¿®æ­£ï¼šç¢ºä¿æœ‰åå­—å¯ä»¥ç”¨æ–¼ç›¸ä¼¼æœå°‹ ---
    // å„ªå…ˆé †åºï¼š1. ç›®å‰å…¨åŸŸæš«å­˜ > 2. è³‡æ–™åº«åº«å­˜ > 3. å…§å»ºç›®éŒ„(Catalog)
    let displayName = currentPartName;
    
    if (!displayName && partData && partData.name) {
        displayName = partData.name;
    }
    
    // å¦‚æœé‚„æ˜¯æ²’åå­—ï¼Œå˜—è©¦å¾éœæ…‹ç›®éŒ„ (window.catalogIndex) æŸ¥æ‰¾
    if (!displayName && window.catalogIndex) {
        // ä½¿ç”¨å¯¬é¬†æ¯”å° (==) é¿å…å­—ä¸²/æ•¸å­—å‹åˆ¥å•é¡Œ
        const catItem = window.catalogIndex.find(c => c.id == partId);
        if (catItem) displayName = catItem.name;
    }

    // æ›´æ–°å…¨åŸŸåç¨±ï¼Œç¢ºä¿å¾ŒçºŒæ“ä½œ(å¦‚æ–°å¢)èƒ½æŠ“åˆ°åå­—
    if (displayName) currentPartName = displayName;
    // ------------------------------------------------

    // 1. æ›´æ–°åŸºæœ¬è³‡æ–™ UI
    document.getElementById('res-part-id').textContent = partId;
    document.getElementById('res-part-name').textContent = displayName || "---"; // ä½¿ç”¨æ‰¾åˆ°çš„åå­—
    
    const img = document.getElementById('api-img');
    const url = currentPartImgUrl || partData?.img;
    if(url) { img.src = url; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
    
    document.getElementById('result-area').classList.remove('hidden');
    
    // 2. è™•ç†ç‹€æ…‹åˆ†æ”¯ (å·²å­˜åœ¨ vs æ–°é›¶ä»¶)
    if(drawers.length > 0) {
        // --- ç‹€æ…‹ï¼šå·²å­˜åœ¨ ---
        document.getElementById('status-exist').classList.remove('hidden');
        document.getElementById('status-new').classList.add('hidden');
        
        // é‡ç½®æ“ä½œå€
        document.getElementById('dynamic-action-area').classList.add('hidden');
        document.getElementById('exist-actions').classList.remove('hidden');
        
        // è¦–è¦ºé¢¨æ ¼ï¼šç¶ è‰²
        document.getElementById('info-card').className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-green-500 transition-all"; 
        
        // é¡¯ç¤ºç›®å‰ä½ç½®åˆ—è¡¨
        document.getElementById('drawer-list').innerHTML = drawers.map(d => {
            const num = parseInt(d.toString().replace('a',''));
            const label = num > 477 ? `<i class="fa-solid fa-bag-shopping mr-1"></i>å¤¾éˆè¢‹ ${d}` : `<i class="fa-solid fa-box-open mr-1"></i>æŠ½å±œ ${d}`;
            const bgClass = num > 477 ? "bg-purple-100 text-purple-800 border-purple-200" : "bg-green-50 text-green-800 border-green-200";
            return `<div class="${bgClass} border px-3 py-1.5 rounded-lg font-bold shadow-sm flex items-center text-sm"><span onclick="openDrawerContent('${d.toString().replace('a','')}')" class="cursor-pointer flex items-center hover:underline">${label}</span><button onclick="removeLoc('${d}')" class="ml-3 w-5 h-5 flex items-center justify-center bg-white rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 shadow-sm transition"><i class="fa-solid fa-xmark text-xs"></i></button></div>`;
        }).join('');

    } else {
        // --- ç‹€æ…‹ï¼šæ–°é›¶ä»¶ ---
        document.getElementById('status-exist').classList.add('hidden');
        document.getElementById('status-new').classList.remove('hidden');
        
        // è¦–è¦ºé¢¨æ ¼ï¼šé»ƒè‰²
        document.getElementById('info-card').className = "bg-white p-4 rounded-xl shadow-lg border-l-8 border-yellow-400 transition-all"; 
        
        // è‡ªå‹•è¼‰å…¥ã€Œæ–°å¢ã€é¢æ¿
        setupActionPanel('add', document.getElementById('inline-action-panel'));
        const inp = document.getElementById('drawer-input-active'); 
        if(inp) inp.value = getNextEmptyDrawerId();
    }

    // 3. çµ±ä¸€è™•ç†ç›¸ä¼¼é›¶ä»¶æ¨è–¦
    const uniContainer = document.getElementById('universal-suggestions');
    const uniList = document.getElementById('universal-similar-list');
    
    // ä½¿ç”¨å‰›å‰›åŠªåŠ›æ‰¾åˆ°çš„ displayName é€²è¡Œæœå°‹
    const suggestions = findSimilarParts(displayName || "");
    
    if (suggestions.length > 0) {
        uniList.innerHTML = suggestions.map(s => {
            const dNum = parseInt(s.drawers[0].toString().replace('a',''));
            const locLabel = dNum > 477 ? `å¤¾éˆè¢‹ ${s.drawers[0]}` : `æŠ½å±œ ${s.drawers[0]}`;
            
            return `<div class="flex items-center p-2 bg-white border border-purple-100 rounded-lg cursor-pointer hover:bg-purple-50 transition shadow-sm group">
                ${s.img?`<img src="${s.img}" class="w-10 h-10 object-contain rounded border mr-3 bg-gray-50">`:'<div class="w-10 h-10 bg-gray-100 rounded mr-3 flex items-center justify-center"><i class="fa-solid fa-cube text-gray-400"></i></div>'}
                <div class="flex-1 min-w-0" onclick="useSuggestedDrawer('${s.drawers[0]}')">
                    <div class="text-xs font-bold text-gray-700 truncate">${s.name}</div>
                    <div class="text-[10px] text-gray-500 font-mono">ID: ${s.id}</div>
                </div>
                <span onclick="event.stopPropagation(); openDrawerContent('${s.drawers[0].toString().replace('a','')}')" class="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded group-hover:bg-purple-200 transition hover:underline hover:scale-105 transform">${locLabel}</span>
            </div>`;
        }).join('');
        uniContainer.classList.remove('hidden');
    } else {
        uniContainer.classList.add('hidden');
    }
}
        // å„ªåŒ–å¾Œçš„å¥—ç”¨æŠ½å±œå‡½å¼
window.useSuggestedDrawer = (drawerId) => { 
    const dStr = drawerId.toString(); 
    
    // æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ´»å‹•çš„è¼¸å…¥æ¡†
    let input = document.getElementById('drawer-input-active');
    
    // [UX å„ªåŒ–] å¦‚æœç›®å‰æ²’æœ‰é–‹å•Ÿçš„æ“ä½œé¢æ¿ (input ä¸å­˜åœ¨)ï¼Œè‡ªå‹•é–‹å•Ÿã€Œç§»å‹•ä½ç½®ã€æ¨¡å¼
    if (!input) {
        // å¦‚æœæ˜¯æ–°é›¶ä»¶æ¨¡å¼ä¸‹çš„ inline panel
        const inlineInput = document.getElementById('inline-action-panel').querySelector('#drawer-input-active');
        if (inlineInput) {
            input = inlineInput;
        } else {
            // é›¶ä»¶å·²å­˜åœ¨ï¼Œä¸”é¢æ¿æœªé–‹ -> è‡ªå‹•é–‹å•Ÿ "Move" é¢æ¿
            showActionPanel('move');
            input = document.getElementById('drawer-input-active');
        }
    }

    // åŸ·è¡Œå¡«å…¥æ•¸å€¼
    if (input) {
        const checkbox = input.parentElement.parentElement.querySelector('input[type="checkbox"]'); 
        input.value = dStr.replace('a',''); 
        if(checkbox) checkbox.checked = dStr.includes('a'); 
        
        // æ»¾å‹•åˆ°æ“ä½œå€ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æ•¸å€¼è®Šäº†
        input.scrollIntoView({behavior: 'smooth', block: 'center'}); 
        
        // è¦–è¦ºå›é¥‹ï¼šè®“è¼¸å…¥æ¡†é–ƒçˆä¸€ä¸‹
        input.classList.add('ring-4', 'ring-purple-300');
        setTimeout(() => input.classList.remove('ring-4', 'ring-purple-300'), 500);
    }
};
		window.showActionPanel = (action) => { const container = document.getElementById('dynamic-action-area'); container.classList.remove('hidden'); document.getElementById('exist-actions').classList.add('hidden'); setupActionPanel(action, container); document.getElementById('drawer-input-active').value = getNextEmptyDrawerId(); };
        function setupActionPanel(action, container) { currentAction = action; container.innerHTML = document.getElementById('action-panel-template').innerHTML; const btn = container.querySelector('#confirm-btn'); const label = container.querySelector('#action-label'); if (action === 'add') { btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white'); btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> ç¢ºèªåŠ å…¥'; label.textContent = "åŠ å…¥ä½ç½®ï¼š"; } else { btn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white'); btn.innerHTML = '<i class="fa-solid fa-arrow-right-arrow-left mr-2"></i> ç¢ºèªç§»å‹• (è¦†è“‹)'; label.textContent = "ç§»å‹•è‡³ï¼š"; } const input = container.querySelector('#drawer-input'); input.id = 'drawer-input-active'; input.onclick = () => openKeypad('drawer-input-active'); container.querySelector('#confirm-btn').onclick = executeAction; }
        window.adjustDrawer = (delta) => { const input = document.getElementById('drawer-input-active'); if(input) { let val = parseInt(input.value)||1; val+=delta; if(val<1)val=1; if(val>9999)val=9999; input.value=val; } };
        window.executeAction = async () => { if(!currentPartId) return; const num = document.getElementById('drawer-input-active').value; const activeContainer = document.getElementById('drawer-input-active').closest('#inline-action-panel') || document.getElementById('dynamic-action-area'); const isSub = activeContainer.querySelector('input[type="checkbox"]').checked; const targetDrawer = isSub ? `${num}a` : `${num}`; const btn = activeContainer.querySelector('#confirm-btn'); const originalHtml = btn.innerHTML; const originalClass = btn.className; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; try { if (currentAction === 'move') { if(confirm(`ç¢ºå®šç§»å‹•ï¼Ÿ\nèˆŠä½ç½®å°‡è¢«ç§»é™¤ã€‚`)) await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'move'); else { btn.innerHTML = originalHtml; btn.disabled = false; return; } } else { await window.saveMappingCloud(currentPartId, targetDrawer, currentPartName, currentPartImgUrl, 'append'); } btn.className = "w-full py-3.5 rounded-xl font-bold text-white shadow-md bg-green-500 transition-all"; btn.innerHTML = '<i class="fa-solid fa-check"></i> æˆåŠŸ'; setTimeout(() => { btn.className = originalClass; btn.innerHTML = originalHtml; btn.disabled = false; if(!document.getElementById('status-exist').classList.contains('hidden')) { document.getElementById('exist-actions').classList.remove('hidden'); document.getElementById('dynamic-action-area').classList.add('hidden'); } }, 1500); } catch(e) { btn.innerHTML = originalHtml; btn.disabled = false; } };
        window.removeLoc = (drawerId) => { if(confirm(`ç¢ºå®šç§»é™¤ï¼Ÿ`)) window.removeMappingCloud(currentPartId, drawerId); };
        window.manualSearch = () => { const id = document.getElementById('part-id-input').value.trim(); if(id) { if(!currentPartName) { currentPartName = ""; currentPartImgUrl = ""; document.getElementById('res-source').textContent = "MANUAL"; document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-gray-500 text-white font-bold"; } document.getElementById('search-suggestions').classList.add('hidden'); checkAndDisplayDrawer(id); } };
        window.retryWithGemini = async () => { if(!currentResizedBlob || !geminiApiKey) { alert("ç„¡åœ–ç‰‡æˆ–æœªè¨­å®š Key"); return; } document.getElementById('loading').classList.remove('hidden'); document.getElementById('loading-text').innerText = "Gemini é‡è©¦ä¸­..."; document.getElementById('result-area').classList.add('hidden'); try { const result = await tryGemini(currentResizedBlob); currentPartName = result.name; currentPartImgUrl = ""; document.getElementById('part-id-input').value = result.id; document.getElementById('res-source').textContent = "Gemini (Retry)"; document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-purple-600 text-white font-bold"; checkAndDisplayDrawer(result.id); } catch(e) { alert(e.message); } finally { document.getElementById('loading').classList.add('hidden'); } };
        function resizeImage(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = (event) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width, height = img.height; if (width > 800) { height = Math.round(height * 800 / width); width = 800; } canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); canvas.toBlob(resolve, 'image/jpeg', 0.85); }; img.src = event.target.result; }; reader.readAsDataURL(file); }); }
        async function tryBrickognize(blob) { const fd = new FormData(); fd.append('query_image', blob); const res = await fetch('https://api.brickognize.com/predict/', {method:'POST', body:fd}); if(res.ok) { const data = await res.json(); if(data.items?.length > 0) return { id: data.items[0].id, name: data.items[0].name, img: data.items[0].img_url || data.items[0].thumbnail_url, source: 'Brickognize' }; } return null; }
        async function tryGemini(blob) { const b64 = await new Promise(r => { const rd = new FileReader(); rd.onloadend = () => r(rd.result.split(',')[1]); rd.readAsDataURL(blob); }); const prompt = `Identify this Lego part. Return JSON: { "id": "PART_ID", "name": "Part Name" }. IMPORTANT: ALWAYS Append common Traditional Chinese keywords for this part (e.g., "Brick 2x4 åŸºç¤ç£š", "Technic Beam ç§‘æŠ€è‡‚", "Gear é½’è¼ª").`; const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contents:[{parts:[{text:prompt}, {inline_data:{mime_type:"image/jpeg", data:b64}}]}], generationConfig:{responseMimeType:"application/json"} }) }); if(!res.ok) throw new Error("API Error"); const json = await res.json(); const data = JSON.parse(json.candidates[0].content.parts[0].text); return { id: data.id, name: data.name, img: "", source: 'Gemini' }; }
        
        window.k = (key) => { 
            let inp = null;
            if(currentKeypadTarget === 'jump-drawer-input') {
                if(key==='del') keypadInputValue = keypadInputValue.slice(0,-1); 
                else if(key==='clr') keypadInputValue = ''; 
                else if(key==='ok') { confirmKeypad(); return; }
                else keypadInputValue += key;
                const span = document.getElementById('drawer-modal-title');
                if(span) span.innerText = keypadInputValue || "-";
                inp = document.getElementById('jump-drawer-input');
                if(inp) inp.value = keypadInputValue;
                return;
            }
            inp = document.getElementById(currentKeypadTarget); 
            if(!inp) return; 
            let newVal = inp.value;
            if(key==='del') newVal = newVal.slice(0,-1); 
            else if(key==='clr') newVal = ''; 
            else if(key==='ok') { confirmKeypad(); return; }
            else newVal += key;
            inp.value = newVal;
        };
// --- ä¿®æ­£å¾Œçš„éµç›¤é‚è¼¯ (è«‹è¦†è“‹åŸæœ¬æœ€ä¸‹æ–¹çš„ Keypad ç›¸é—œå‡½å¼) ---

// 2. é–‹å•Ÿéµç›¤ (ä¿®æ­£ï¼šé˜²æ­¢ hidden input è§¸ç™¼æ²å‹•)
window.openKeypad = (id) => { 
    currentKeypadTarget = id; 
    const modal = document.getElementById('keypad-modal'); 
    const content = document.getElementById('keypad-content'); 
    
    // é‡ç½®é è¦½æ–‡å­—
    const preview = document.getElementById('keypad-preview');
    const targetInput = document.getElementById(id);
    if(preview && targetInput) preview.innerText = targetInput.value;

    modal.classList.remove('hidden'); 
    requestAnimationFrame(() => content.classList.remove('translate-y-full')); 
    
    // é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯ 'global-jump-input' (éš±è—æ¬„ä½)ï¼Œä¸è¦åŸ·è¡Œ scrollIntoViewï¼Œå¦å‰‡ç•«é¢æœƒäº‚è·³
    if(id !== 'global-jump-input') {
        document.getElementById('main-content').classList.add('pb-keypad'); 
        setTimeout(() => document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}), 300); 
    }
};


        window.toggleSettings = () => { const m = document.getElementById('settings-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) { document.getElementById('gemini-key').value = geminiApiKey; document.getElementById('gemini-model').value = geminiModel; if(geminiApiKey) document.getElementById('key-saved-msg').classList.remove('hidden'); else document.getElementById('key-saved-msg').classList.add('hidden'); } };
        window.saveSettings = () => { geminiApiKey = document.getElementById('gemini-key').value.trim(); geminiModel = document.getElementById('gemini-model').value; localStorage.setItem('lego_gemini_key', geminiApiKey); localStorage.setItem('lego_gemini_model', geminiModel); toggleSettings(); showMessage("è¨­å®šå·²å„²å­˜", "success"); };
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');

        // --- NEW: Drawer Modal Logic with Navigation ---
        window.openDrawerContent = (drawerId) => {
            const modal = document.getElementById('drawer-modal');
            const title = document.getElementById('drawer-modal-title');
            const content = document.getElementById('drawer-modal-content');
            
            const dStr = drawerId.toString();
            currentViewingDrawer = dStr;

            // Reset jump input state
            keypadInputValue = dStr;
            const jumpInput = document.getElementById('jump-drawer-input');
            if(jumpInput) jumpInput.value = dStr;
            if(title) {
                title.innerText = dStr;
                title.classList.remove('animate-pulse');
            }

            const num = parseInt(dStr.replace('a',''));
            const prefix = num > 477 ? "å¤¾éˆè¢‹" : "æŠ½å±œ";

            const partsInDrawer = [];
            Object.entries(window.mappings).forEach(([pid, data]) => {
                if (data.drawers && (data.drawers.includes(dStr) || data.drawers.includes(dStr+'a') || data.drawers.includes(dStr.replace('a','')))) {
                    if(data.drawers.includes(dStr)) partsInDrawer.push({ id: pid, ...data });
                }
            });

            if (partsInDrawer.length === 0) {
                content.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-8">æ­¤ä½ç½®æ˜¯ç©ºçš„</div>';
            } else {
                content.innerHTML = partsInDrawer.map(p => `
                    <div class="flex flex-col items-center p-2 border rounded-lg hover:bg-blue-50 cursor-pointer transition bg-white relative" onclick="selectPartFromDrawer('${p.id}')">
                        ${p.img ? `<img src="${p.img}" class="w-16 h-16 object-contain mb-2">` : `<div class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center mb-2"><i class="fa-solid fa-cube text-gray-300 text-2xl"></i></div>`}
                        <span class="font-bold text-xs text-blue-600 font-mono break-all text-center">${p.id}</span>
                        <span class="text-[10px] text-gray-500 truncate w-full text-center mt-1">${p.name}</span>
                    </div>
                `).join('');
            }
            modal.classList.remove('hidden');
        };

        window.navDrawer = (delta) => {
            let num = parseInt(currentViewingDrawer.replace('a', '')) || 1;
            num += delta;
            if (num < 1) num = 1;
            openDrawerContent(num.toString());
        };


        window.closeDrawerModal = () => { document.getElementById('drawer-modal').classList.add('hidden'); };
        
        window.selectPartFromDrawer = (partId) => { 
    closeDrawerModal(); 

    // --- ä¿®æ­£é–‹å§‹ï¼šæ¸…ç©ºæš«å­˜ç‹€æ…‹ ---
    // å¼·åˆ¶æ¸…ç©ºå…¨åŸŸçš„åœ–ç‰‡å’Œåç¨±è®Šæ•¸ï¼Œç¢ºä¿ checkAndDisplayDrawer æœƒè®€å–è³‡æ–™åº«(partData)çš„å…§å®¹
    currentPartImgUrl = ""; 
    currentPartName = ""; 
    currentResizedBlob = null; // é †æ‰‹æ¸…ç©ºåœ–ç‰‡ blobï¼Œé¿å…èª¤è§¸é‡è©¦æŒ‰éˆ•

    // è¦–è¦ºå„ªåŒ–ï¼šå°‡ä¾†æºæ¨™ç±¤æ”¹ç‚º Database æˆ– Inventory
    document.getElementById('res-source').textContent = "INVENTORY";
    document.getElementById('res-source').className = "text-[10px] px-2 py-0.5 rounded bg-blue-500 text-white font-bold";
    // --- ä¿®æ­£çµæŸ ---

    // å»¶é²ä¸€é»é»åŸ·è¡Œï¼Œç¢ºä¿è¦–è¦ºæ›´æ–°
    setTimeout(() => {
        checkAndDisplayDrawer(partId); 
    }, 100);
};
    </script>
</body>
</html>
